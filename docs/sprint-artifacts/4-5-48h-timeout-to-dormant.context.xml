<story-context id="bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>5</storyId>
    <title>48h Timeout to Dormant</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-22</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-5-48h-timeout-to-dormant.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system</asA>
    <iWant>to auto-transition users to dormant after 48 hours without a goodbye response</iWant>
    <soThat>we stop waiting and respect the implicit choice of non-response</soThat>
    <tasks>
      <task id="1" ac="1">
        <title>Implement getExpiredGoodbyes() query function</title>
        <subtasks>
          <subtask>Add function to services/engagement/state-machine.ts</subtask>
          <subtask>Query: SELECT * FROM user_engagement_states WHERE state = 'goodbye_sent' AND goodbye_expires_at &lt; NOW()</subtask>
          <subtask>Use existing index idx_engagement_goodbye_expires for performance</subtask>
          <subtask>Return array of UserEngagementState objects</subtask>
          <subtask>Handle empty results (no expired goodbyes)</subtask>
        </subtasks>
        <note>ALREADY IMPLEMENTED - getExpiredGoodbyes() exists in state-machine.ts:592-614</note>
      </task>
      <task id="2" ac="2,6">
        <title>Add goodbye_timeout trigger to state machine</title>
        <subtasks>
          <subtask>Add goodbye_timeout to TransitionTrigger type in types.ts</subtask>
          <subtask>Add transition rule: goodbye_sent + goodbye_timeout → dormant</subtask>
          <subtask>Ensure transitionState() logs to engagement_state_transitions</subtask>
          <subtask>Validate that only goodbye_sent state can receive this trigger</subtask>
        </subtasks>
        <note>ALREADY IMPLEMENTED - goodbye_timeout exists in types.ts:38 and TRANSITION_MAP:171</note>
      </task>
      <task id="3" ac="3,4">
        <title>Implement timeout transition side effects</title>
        <subtasks>
          <subtask>DO NOT queue any message (silence by design)</subtask>
          <subtask>Set metadata.response_type = 'timeout'</subtask>
          <subtask>Set metadata.days_inactive = days since last_activity_at</subtask>
          <subtask>Clear goodbye_sent_at and goodbye_expires_at on transition</subtask>
          <subtask>Update updated_at timestamp</subtask>
        </subtasks>
        <note>PARTIAL - transitionState() already handles dormant but needs explicit metadata for timeout transitions</note>
      </task>
      <task id="4" ac="1,5">
        <title>Extend daily engagement job for timeout processing</title>
        <subtasks>
          <subtask>In services/scheduler/daily-engagement-job.ts add timeout step</subtask>
          <subtask>Call getExpiredGoodbyes() after inactivity check</subtask>
          <subtask>Call transitionState(user_id, 'goodbye_timeout') for each expired user</subtask>
          <subtask>Use try/catch per user for batch resilience</subtask>
          <subtask>Log count of processed timeouts in job summary</subtask>
        </subtasks>
        <note>STUB EXISTS - daily-engagement-job.ts has stub; needs full implementation</note>
      </task>
      <task id="5" ac="5">
        <title>Implement idempotency for timeout transitions</title>
        <subtasks>
          <subtask>Transition naturally idempotent: user in dormant won't appear in getExpiredGoodbyes()</subtask>
          <subtask>Add defensive check: skip if user not in goodbye_sent state</subtask>
          <subtask>Log warning if transition skipped</subtask>
        </subtasks>
      </task>
      <task id="6" ac="4">
        <title>Add PostHog analytics event</title>
        <subtasks>
          <subtask>Fire engagement_goodbye_response event with response_type: 'timeout'</subtask>
          <subtask>Include user_id, days_since_goodbye, hours_waited</subtask>
          <subtask>Use same event name as response processing for unified analytics</subtask>
        </subtasks>
      </task>
      <task id="7" ac="1-6">
        <title>Write unit tests for timeout functionality</title>
        <subtasks>
          <subtask>Test: getExpiredGoodbyes() returns users with goodbye_expires_at &lt; now</subtask>
          <subtask>Test: getExpiredGoodbyes() excludes users with goodbye_expires_at > now</subtask>
          <subtask>Test: getExpiredGoodbyes() excludes users not in goodbye_sent state</subtask>
          <subtask>Test: transitionState(userId, 'goodbye_timeout') transitions to dormant</subtask>
          <subtask>Test: Invalid trigger on non-goodbye_sent state is rejected</subtask>
          <subtask>Test: No message queued on timeout transition</subtask>
          <subtask>Test: Metadata includes response_type: 'timeout'</subtask>
          <subtask>Test: Daily job processes multiple expired users</subtask>
          <subtask>Test: Daily job re-run doesn't cause duplicate transitions</subtask>
          <subtask>Test: PostHog event fired with correct properties</subtask>
        </subtasks>
        <note>PARTIAL - state-machine.test.ts has goodbye_timeout tests; need additional coverage for daily job</note>
      </task>
      <task id="8" ac="5,6">
        <title>Add edge case handling</title>
        <subtasks>
          <subtask>Handle database connection failures gracefully</subtask>
          <subtask>Handle race condition: user responds during job execution</subtask>
          <subtask>Log structured error details for debugging</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.5.1">getExpiredGoodbyes() returns users where state = 'goodbye_sent' AND goodbye_expires_at &lt; now()</criterion>
    <criterion id="AC-4.5.2">Transition trigger is goodbye_timeout (distinct from goodbye_response_3)</criterion>
    <criterion id="AC-4.5.3">No message is sent on timeout - silence is design (dignity, not guilt)</criterion>
    <criterion id="AC-4.5.4">Metadata includes response_type: 'timeout' for analytics (FR40)</criterion>
    <criterion id="AC-4.5.5">Multiple daily job runs don't cause duplicate transitions (idempotency)</criterion>
    <criterion id="AC-4.5.6">State transition is logged to engagement_state_transitions table</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Smart Onboarding &amp; Engagement System</title>
        <section>ADR-005: Single Daily Job for Timeouts</section>
        <snippet>Check 48h goodbye timeout in daily job rather than precise scheduling. Precision not critical (48h vs 49h doesn't matter for UX). Simplifies scheduler complexity.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - State Transition Contract</title>
        <section>VALID_TRANSITIONS Map</section>
        <snippet>goodbye_sent + goodbye_timeout → dormant is defined in VALID_TRANSITIONS. State transition uses optimistic locking via updated_at check.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>Story 4.5: 48h Timeout to Dormant</section>
        <snippet>AC4.5.1-4: getExpiredGoodbyes() returns expired users, trigger is goodbye_timeout, no message on timeout, metadata includes response_type: 'timeout'.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification</title>
        <section>API: getExpiredGoodbyes()</section>
        <snippet>Returns users where state='goodbye_sent' AND goodbye_expires_at &lt; now. Used by scheduler to trigger goodbye_timeout transitions.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Analytics Events</title>
        <section>PostHog Events</section>
        <snippet>engagement_goodbye_response event with response_type (confused/busy/all_good/timeout) fired on user response or timeout.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>whatsapp-bot/src/services/engagement/state-machine.ts</path>
        <kind>service</kind>
        <symbol>getExpiredGoodbyes</symbol>
        <lines>592-614</lines>
        <reason>ALREADY IMPLEMENTED - Query function returns users with expired goodbye messages. Story needs to verify/enhance this implementation.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/services/engagement/state-machine.ts</path>
        <kind>service</kind>
        <symbol>transitionState</symbol>
        <lines>92-295</lines>
        <reason>Core transition function that handles goodbye_timeout trigger. Needs enhancement to include response_type: 'timeout' metadata.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/services/engagement/state-machine.ts</path>
        <kind>service</kind>
        <symbol>buildStateUpdateData</symbol>
        <lines>376-412</lines>
        <reason>Handles state-specific timestamp updates. Need to verify dormant case clears goodbye timestamps.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/services/engagement/types.ts</path>
        <kind>types</kind>
        <symbol>TransitionTrigger, TRANSITION_MAP</symbol>
        <lines>32-183</lines>
        <reason>ALREADY IMPLEMENTED - goodbye_timeout trigger defined at line 38, transition rule at line 171.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/services/engagement/constants.ts</path>
        <kind>constants</kind>
        <symbol>GOODBYE_TIMEOUT_HOURS</symbol>
        <lines>27</lines>
        <reason>Defines 48h timeout constant used in state machine.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/services/scheduler/daily-engagement-job.ts</path>
        <kind>service</kind>
        <symbol>runDailyEngagementJob</symbol>
        <lines>43-62</lines>
        <reason>STUB - Currently returns placeholder. Needs full implementation to process expired goodbyes.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/services/scheduler/message-sender.ts</path>
        <kind>service</kind>
        <symbol>queueMessage, getIdempotencyKey</symbol>
        <lines>45-129</lines>
        <reason>Message queue service - verify timeout transition does NOT call queueMessage (silence by design).</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/__tests__/services/engagement/state-machine.test.ts</path>
        <kind>test</kind>
        <symbol>goodbye_timeout tests</symbol>
        <lines>239-256</lines>
        <reason>Existing test for goodbye_timeout transition. Add tests for no message queuing, metadata content, daily job processing.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/__tests__/services/engagement/state-machine.test.ts</path>
        <kind>test</kind>
        <symbol>getExpiredGoodbyes tests</symbol>
        <lines>702-728</lines>
        <reason>Existing tests for getExpiredGoodbyes query function.</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package>@supabase/supabase-js</package>
        <version>^2.39.3</version>
        <purpose>Database access for engagement state queries</purpose>
      </node>
      <node>
        <package>posthog-node</package>
        <version>^5.11.2</version>
        <purpose>Analytics event tracking for goodbye timeout</purpose>
      </node>
      <node>
        <package>jest</package>
        <version>^29.7.0</version>
        <purpose>Testing framework</purpose>
      </node>
      <node>
        <package>ts-jest</package>
        <version>^29.1.1</version>
        <purpose>TypeScript Jest preset</purpose>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture">All state changes MUST go through transitionState() - never update DB directly</constraint>
    <constraint source="architecture">State transitions must be idempotent and safe to retry</constraint>
    <constraint source="architecture">Every transition logged to engagement_state_transitions table</constraint>
    <constraint source="prd">Silence by design - no message sent on timeout (dignity, not guilt)</constraint>
    <constraint source="adr-005">Daily job checks goodbye_expires_at - precision not critical (48h vs 49h acceptable)</constraint>
    <constraint source="dev-notes">Maximum timeout overshoot is ~24h due to daily job timing - acceptable per product requirements</constraint>
    <constraint source="architecture">Scheduler: Log and continue (batch resilience) - use try/catch per user</constraint>
    <constraint source="test">Coverage threshold: 70% for branches, functions, lines, statements</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>getExpiredGoodbyes</name>
      <kind>function</kind>
      <signature>async function getExpiredGoodbyes(): Promise&lt;UserEngagementState[]&gt;</signature>
      <path>whatsapp-bot/src/services/engagement/state-machine.ts</path>
    </interface>
    <interface>
      <name>transitionState</name>
      <kind>function</kind>
      <signature>async function transitionState(userId: string, trigger: TransitionTrigger, metadata?: Record&lt;string, unknown&gt;): Promise&lt;TransitionResult&gt;</signature>
      <path>whatsapp-bot/src/services/engagement/state-machine.ts</path>
    </interface>
    <interface>
      <name>runDailyEngagementJob</name>
      <kind>function</kind>
      <signature>async function runDailyEngagementJob(): Promise&lt;JobResult&gt;</signature>
      <path>whatsapp-bot/src/services/scheduler/daily-engagement-job.ts</path>
    </interface>
    <interface>
      <name>TransitionTrigger</name>
      <kind>type</kind>
      <signature>type TransitionTrigger = 'user_message' | 'inactivity_14d' | 'goodbye_response_1' | 'goodbye_response_2' | 'goodbye_response_3' | 'goodbye_timeout' | 'reminder_due' | 'help_requested' | 'help_resolved'</signature>
      <path>whatsapp-bot/src/services/engagement/types.ts</path>
    </interface>
    <interface>
      <name>UserEngagementState</name>
      <kind>interface</kind>
      <signature>interface UserEngagementState { id: string; userId: string; state: EngagementState; lastActivityAt: Date; goodbyeSentAt: Date | null; goodbyeExpiresAt: Date | null; remindAt: Date | null; createdAt: Date; updatedAt: Date; }</signature>
      <path>whatsapp-bot/src/services/engagement/types.ts</path>
    </interface>
    <interface>
      <name>JobResult</name>
      <kind>interface</kind>
      <signature>interface JobResult { success: boolean; usersProcessed: number; goodbyesSent: number; timeoutsProcessed: number; remindersProcessed: number; errors: string[]; durationMs: number; }</signature>
      <path>whatsapp-bot/src/services/scheduler/daily-engagement-job.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing uses Jest with ts-jest ESM preset. Tests are colocated in __tests__ directories mirroring source structure.
      Mock Supabase via __mocks__/supabase.ts using mockQuerySequence for chained calls.
      Mock logger via jest.mock. Coverage threshold is 70% globally for branches, functions, lines, and statements.
      Use jest.useFakeTimers() and jest.setSystemTime() for time-dependent tests.
    </standards>
    <locations>
      <location>whatsapp-bot/src/__tests__/services/engagement/state-machine.test.ts</location>
      <location>whatsapp-bot/src/__tests__/engagement/*.test.ts</location>
      <location>whatsapp-bot/src/__tests__/services/scheduler/*.test.ts</location>
    </locations>
    <ideas>
      <idea ac="AC-4.5.1">Test getExpiredGoodbyes() returns users where goodbye_expires_at &lt; now and state='goodbye_sent'</idea>
      <idea ac="AC-4.5.1">Test getExpiredGoodbyes() excludes users with goodbye_expires_at > now (not yet expired)</idea>
      <idea ac="AC-4.5.1">Test getExpiredGoodbyes() excludes users in other states (active, dormant)</idea>
      <idea ac="AC-4.5.2">Test transitionState(userId, 'goodbye_timeout') triggers dormant transition from goodbye_sent</idea>
      <idea ac="AC-4.5.2">Test goodbye_timeout trigger on non-goodbye_sent state is rejected</idea>
      <idea ac="AC-4.5.3">Test no message queued during goodbye_timeout transition (verify queueMessage NOT called)</idea>
      <idea ac="AC-4.5.4">Test transition metadata includes response_type: 'timeout' and days_inactive</idea>
      <idea ac="AC-4.5.4">Test PostHog event engagement_goodbye_response fired with response_type: 'timeout'</idea>
      <idea ac="AC-4.5.5">Test daily job processes batch of expired users without failing on single error</idea>
      <idea ac="AC-4.5.5">Test daily job re-run doesn't duplicate transitions (users already in dormant)</idea>
      <idea ac="AC-4.5.6">Test engagement_state_transitions record created with from_state, to_state, trigger</idea>
      <idea ac="edge-case">Test race condition: user responds while job is running (handle gracefully)</idea>
      <idea ac="edge-case">Test database connection failure doesn't crash job (logs error, continues)</idea>
    </ideas>
  </tests>
</story-context>
