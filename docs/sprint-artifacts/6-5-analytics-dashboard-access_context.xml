<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>6-5-analytics-dashboard-access</story-id>
    <story-title>Analytics Dashboard Access</story-title>
    <epic-id>6</epic-id>
    <epic-title>User Preferences &amp; Web Integration</epic-title>
    <generated-date>2025-11-24</generated-date>
    <context-version>1.0</context-version>
  </metadata>

  <story-overview>
    <description>
      Provide comprehensive analytics access for monitoring engagement preference changes and opt-out metrics.
      This is a documentation-heavy story focused on making PostHog events, database queries, and scheduler logs
      accessible to product/dev teams through clear documentation, sample queries, and monitoring scripts.
    </description>

    <acceptance-criteria>
      <criterion id="AC-6.5.1">
        PostHog events tracked with required schema: event name 'engagement_preference_changed' includes
        properties user_id, preference (opted_in/opted_out), source (whatsapp/web), and timestamp.
      </criterion>
      <criterion id="AC-6.5.2">
        Database queries available to calculate: total users, opted-out users, opt-out rate, and opt-back-in count
        from user_profiles table.
      </criterion>
      <criterion id="AC-6.5.3">
        Scheduler logs include metrics: users skipped per day due to opt-out, total eligible users vs. actually
        queued messages for both daily and weekly jobs.
      </criterion>
      <criterion id="AC-6.5.4">
        Documentation includes: PostHog event queries with dashboard setup, SQL queries for database metrics,
        and scheduler log parsing examples with CloudWatch/Railway access patterns.
      </criterion>
      <criterion id="AC-6.5.5">
        Monitoring script implemented for spike detection: alerts when opt-out rate exceeds 20% in 24 hours,
        indicating potential messaging issues.
      </criterion>
    </acceptance-criteria>

    <key-technical-requirements>
      <requirement>Document PostHog event schema and sample queries</requirement>
      <requirement>Create SQL queries for opt-out metrics and trends</requirement>
      <requirement>Document scheduler logging format and parsing patterns</requirement>
      <requirement>Create analytics dashboard setup guide</requirement>
      <requirement>Implement opt-out rate spike detection script</requirement>
      <requirement>Validate PostHog event schema via integration tests</requirement>
      <requirement>Enhance scheduler logging with structured JSON output</requirement>
    </key-technical-requirements>
  </story-overview>

  <architecture-context>
    <analytics-data-sources>
      <source type="posthog">
        <description>Real-time preference change tracking from Stories 6.1 and 6.2</description>
        <event-name>engagement_preference_changed</event-name>
        <properties>
          <property name="user_id" type="string" description="User database ID"/>
          <property name="preference" type="enum" values="opted_out|opted_in"/>
          <property name="source" type="enum" values="whatsapp|web"/>
          <property name="timestamp" type="string" format="ISO-8601"/>
        </properties>
        <use-cases>
          <use-case>Real-time preference change tracking</use-case>
          <use-case>Channel distribution analysis (whatsapp vs web)</use-case>
          <use-case>Opt-back-in funnel tracking</use-case>
          <use-case>Opt-out rate over time trends</use-case>
        </use-cases>
      </source>

      <source type="database">
        <description>Current opt-out status via user_profiles table</description>
        <table>user_profiles</table>
        <column name="reengagement_opt_out" type="boolean" default="false"/>
        <access>Direct queries via Supabase dashboard or psql</access>
        <use-cases>
          <use-case>Current opt-out status snapshot</use-case>
          <use-case>Aggregate statistics (total users, opted-out users)</use-case>
          <use-case>Opt-out rate calculation</use-case>
        </use-cases>
      </source>

      <source type="scheduler-logs">
        <description>Messages skipped due to opt-out from Epic 5 jobs</description>
        <services>
          <service>whatsapp-bot/src/services/scheduler/daily-engagement-job.ts</service>
          <service>whatsapp-bot/src/services/scheduler/weekly-review-job.ts</service>
        </services>
        <format>Structured JSON logs</format>
        <use-cases>
          <use-case>Messages skipped due to opt-out per day/week</use-case>
          <use-case>Queue sizes (eligible vs actually queued)</use-case>
          <use-case>Opt-out filter effectiveness validation</use-case>
        </use-cases>
      </source>
    </analytics-data-sources>

    <key-metrics>
      <metric name="Opt-out rate">
        <calculation>(opted_out_users / total_users) * 100</calculation>
        <data-source>Database</data-source>
        <target>&lt; 10% expected</target>
        <alert-threshold>&gt; 20% in 24 hours</alert-threshold>
      </metric>

      <metric name="Opt-in after opt-out">
        <calculation>Count opt-in events where user previously opted out</calculation>
        <data-source>PostHog events</data-source>
        <target>&gt; 30% of opt-outs</target>
      </metric>

      <metric name="Channel preference">
        <calculation>Distribution of source: whatsapp vs web</calculation>
        <data-source>PostHog events</data-source>
        <purpose>Track for UX improvements</purpose>
      </metric>

      <metric name="Scheduler skips">
        <calculation>Users filtered by opt-out in daily/weekly jobs</calculation>
        <data-source>Scheduler logs</data-source>
        <expected>Should grow linearly with opt-out rate</expected>
      </metric>

      <metric name="Opt-out spike">
        <calculation>Opt-outs in last 24h vs baseline</calculation>
        <data-source>PostHog events</data-source>
        <alert-threshold>&gt; 20% = alert</alert-threshold>
      </metric>
    </key-metrics>
  </architecture-context>

  <existing-code-context>
    <posthog-integration>
      <whatsapp-bot>
        <file path="whatsapp-bot/src/analytics/posthog-client.ts">
          <export>getPostHog(): PostHog | null</export>
          <export>trackEvent(event: string, distinctId: string, properties: object)</export>
        </file>
        <event-tracking location="whatsapp-bot/src/handlers/engagement/opt-out-handler.ts">
          <event>engagement_preference_changed</event>
          <properties>
            {
              user_id: userId,
              preference: 'opted_out' | 'opted_in',
              source: 'whatsapp',
              timestamp: new Date().toISOString()
            }
          </properties>
        </event-tracking>
      </whatsapp-bot>

      <frontend>
        <file path="fe/lib/analytics/tracker.ts">
          <export>trackEvent(event: AnalyticsEvent, properties?: object)</export>
        </file>
        <event-tracking location="fe/app/[locale]/settings/account/page.tsx">
          <event>engagement_preference_changed</event>
          <properties>
            {
              user_id: userId,
              preference: 'opted_out' | 'opted_in',
              source: 'web',
              timestamp: new Date().toISOString()
            }
          </properties>
        </event-tracking>
      </frontend>

      <dashboard-access>
        <url>app.posthog.com (credentials in team vault)</url>
        <project>NexFinApp</project>
        <note>Queries and dashboards created from documentation examples</note>
      </dashboard-access>
    </posthog-integration>

    <database-schema>
      <table name="user_profiles">
        <column name="id" type="UUID" primary-key="true"/>
        <column name="user_id" type="UUID" foreign-key="auth.users.id"/>
        <column name="reengagement_opt_out" type="BOOLEAN" default="false">
          <comment>
            If true, user has opted out of re-engagement messages (goodbye, weekly review).
            Onboarding tips still allowed.
          </comment>
          <migration>fe/scripts/034_engagement_system.sql</migration>
          <added-in>Epic 1, Story 1.1</added-in>
        </column>
        <column name="created_at" type="TIMESTAMPTZ"/>
        <column name="updated_at" type="TIMESTAMPTZ"/>
      </table>

      <query-access>
        <method name="Supabase Dashboard">
          <url>supabase.com/dashboard/project/{project-ref}/sql</url>
          <auth>Database password (in .env)</auth>
        </method>
        <method name="psql CLI">
          <command>psql $DATABASE_URL &lt; query.sql</command>
          <auth>Connection string from SUPABASE_URL</auth>
        </method>
        <method name="Direct Query">
          <note>Use queries from docs/analytics/sql-queries.md</note>
        </method>
      </query-access>
    </database-schema>

    <scheduler-logging>
      <daily-job path="whatsapp-bot/src/services/scheduler/daily-engagement-job.ts">
        <current-logging lines="56-95">
          <log-event>Daily engagement job started</log-event>
          <log-event>Daily engagement job completed</log-event>
          <fields>duration_ms, processed, succeeded, failed, skipped</fields>
        </current-logging>
        <enhancement-needed>
          Add structured logging for opt-out metrics:
          - total_eligible_users (before opt-out filter)
          - opted_out_users_skipped (filtered by reengagement_opt_out=true)
          - messages_queued (after opt-out filter)
          - opt_out_filter_rate (percentage skipped)
        </enhancement-needed>
      </daily-job>

      <weekly-job path="whatsapp-bot/src/services/scheduler/weekly-review-job.ts">
        <current-logging lines="50-62">
          <log-event>Weekly review job started</log-event>
          <log-event>Active users detected for weekly review</log-event>
          <fields>count, note about opted-out users excluded</fields>
        </current-logging>
        <enhancement-needed>
          Add structured logging for opt-out metrics:
          - total_eligible_users (all active users)
          - opted_out_users_skipped (filtered by SQL function)
          - messages_queued (after opt-out filter)
          - opt_out_filter_rate (percentage skipped)
        </enhancement-needed>
      </weekly-job>

      <log-access>
        <railway>
          <command>railway logs --service whatsapp-bot --tail</command>
          <web-ui>https://railway.app/project/{project-id}/service/{service-id}/logs</web-ui>
        </railway>
        <cloudwatch>
          <note>If deployed to AWS Lambda/ECS</note>
          <web-ui>CloudWatch Logs console</web-ui>
        </cloudwatch>
      </log-access>
    </scheduler-logging>

    <logger path="whatsapp-bot/src/services/monitoring/logger.js">
      <usage>
        import { logger } from '../monitoring/logger.js'
        logger.info('Opt-out metrics', {
          total_eligible_users: 150,
          opted_out_users_skipped: 23,
          messages_queued: 127,
          opt_out_filter_rate: 15.3
        })
      </usage>
      <note>Structured logging outputs JSON format for easy parsing</note>
    </logger>
  </existing-code-context>

  <implementation-guidance>
    <task-breakdown>
      <task id="1" title="Document PostHog event schema and queries" priority="high">
        <file-to-create>docs/analytics/engagement-preferences.md</file-to-create>
        <content>
          - Document engagement_preference_changed event schema
          - Provide sample PostHog queries for common analytics needs
          - Include dashboard filter syntax and chart configurations
          - Add screenshots or query templates for dashboard setup
        </content>
        <sample-queries>
          <query name="Opt-out rate over time (daily)">
            Event: engagement_preference_changed
            Filter: preference = 'opted_out'
            Breakdown: Day
            Chart: Line chart
          </query>
          <query name="Channel distribution">
            Event: engagement_preference_changed
            Breakdown: source
            Chart: Pie chart
          </query>
          <query name="Opt-back-in funnel">
            Step 1: engagement_preference_changed (preference = 'opted_out')
            Step 2: engagement_preference_changed (preference = 'opted_in')
            Chart: Funnel
          </query>
        </sample-queries>
      </task>

      <task id="2" title="Create SQL queries for database metrics" priority="high">
        <file-to-create>docs/analytics/sql-queries.md</file-to-create>
        <content>
          - Document query for total user count
          - Document query for opted-out users count
          - Document query for opt-out rate calculation
          - Document query for opt-back-in count (via events)
          - Include time-series queries (opt-out trend over days/weeks)
          - Add performance notes for large datasets (indexing recommendations)
        </content>
        <sample-query name="Total opt-out rate">
          <![CDATA[
SELECT
  COUNT(*) as total_users,
  COUNT(*) FILTER (WHERE reengagement_opt_out = true) as opted_out_users,
  ROUND(
    (COUNT(*) FILTER (WHERE reengagement_opt_out = true)::numeric / COUNT(*)::numeric) * 100,
    2
  ) as opt_out_rate_percent
FROM user_profiles
WHERE id IN (SELECT id FROM auth.users); -- Only active users
          ]]>
        </sample-query>
      </task>

      <task id="3" title="Document scheduler log metrics" priority="medium">
        <file-to-create>docs/analytics/scheduler-metrics.md</file-to-create>
        <content>
          - Document log format for users skipped due to opt-out
          - Provide example log parsing scripts (grep/awk patterns)
          - Document metrics to extract from scheduler logs
          - Include example CloudWatch/Railway log queries
        </content>
        <log-format>
          <![CDATA[
{
  "timestamp": "2025-11-24T10:00:00Z",
  "job": "daily-engagement-job",
  "total_eligible_users": 150,
  "opted_out_users_skipped": 23,
  "messages_queued": 127,
  "opt_out_filter_rate": 15.3
}
          ]]>
        </log-format>
      </task>

      <task id="4" title="Create analytics dashboard setup guide" priority="medium">
        <file-to-create>docs/analytics/dashboard-setup.md</file-to-create>
        <content>
          - Document PostHog dashboard creation steps
          - List recommended charts/widgets
          - Document SQL query execution patterns (direct Supabase queries)
          - Document scheduler log access patterns (Railway CLI or CloudWatch)
          - Include troubleshooting section for common query issues
        </content>
        <recommended-charts>
          <chart>Opt-out rate over time (line chart)</chart>
          <chart>Opt-out source distribution (pie chart)</chart>
          <chart>Opt-back-in funnel (funnel chart)</chart>
          <chart>Daily opt-out events (bar chart)</chart>
        </recommended-charts>
      </task>

      <task id="5" title="Implement opt-out rate spike detection" priority="high">
        <file-to-create>scripts/analytics/check-optout-spike.ts</file-to-create>
        <implementation>
          <![CDATA[
// scripts/analytics/check-optout-spike.ts

import { PostHog } from 'posthog-node'
import { createClient } from '@supabase/supabase-js'

async function checkOptOutSpike() {
  // 1. Query PostHog for last 24h opt-out events
  const events = await postHog.query({
    event: 'engagement_preference_changed',
    filter: { preference: 'opted_out' },
    dateRange: 'last_24_hours'
  })

  const optOutCount = events.length

  // 2. Get total user count from database
  const { count: totalUsers } = await supabase
    .from('user_profiles')
    .select('*', { count: 'exact', head: true })

  // 3. Calculate opt-out rate
  const optOutRate = (optOutCount / totalUsers) * 100

  // 4. Alert if > 20%
  if (optOutRate > 20) {
    console.error('OPT-OUT SPIKE DETECTED', {
      opt_out_count: optOutCount,
      total_users: totalUsers,
      opt_out_rate: optOutRate,
      threshold: 20,
      action_required: 'Review message tone and frequency in Epics 4-5'
    })
    // Optional: Send alert via email/Slack
  } else {
    console.info('Opt-out rate within normal range', {
      opt_out_rate: optOutRate,
      opt_out_count: optOutCount
    })
  }
}
          ]]>
        </implementation>
        <deployment>
          <method>Railway cron job (daily at midnight)</method>
          <method>Manual execution via npm run analytics:check-spike</method>
        </deployment>
      </task>

      <task id="6" title="Create sample analytics queries file" priority="low">
        <file-to-create>scripts/analytics/sample-queries.sql</file-to-create>
        <content>
          - Include queries from Task 2 as executable SQL
          - Add comments explaining each query's purpose
          - Include example output formats
          - Add instructions for running queries via psql or Supabase dashboard
        </content>
      </task>

      <task id="7" title="Add analytics queries to README" priority="low">
        <file-to-modify>README.md</file-to-modify>
        <content>
          - Update README with "Analytics &amp; Monitoring" section
          - Link to analytics documentation files
          - Provide quick-start queries for common metrics
          - Document how to access PostHog dashboard
          - Document how to access Railway/CloudWatch logs
        </content>
      </task>

      <task id="8" title="Write integration test for PostHog event schema" priority="high">
        <file-to-create>whatsapp-bot/src/__tests__/analytics/posthog-events.test.ts</file-to-create>
        <tests>
          <test>Mock PostHog tracking calls from Stories 6.1 and 6.2</test>
          <test>Verify event name: engagement_preference_changed</test>
          <test>Verify required properties present: user_id, preference, source, timestamp</test>
          <test>Verify property values are correct types</test>
          <test>Verify source is either 'whatsapp' or 'web'</test>
          <test>Verify preference is either 'opted_in' or 'opted_out'</test>
        </tests>
      </task>

      <task id="9" title="Validate scheduler logging output" priority="medium">
        <files-to-modify>
          <file>whatsapp-bot/src/services/scheduler/daily-engagement-job.ts</file>
          <file>whatsapp-bot/src/services/scheduler/weekly-review-job.ts</file>
        </files-to-modify>
        <enhancement>
          Add structured logging with opt-out metrics:
          - Log total eligible users (before opt-out filter)
          - Log opted-out users skipped count
          - Log messages queued (after opt-out filter)
          - Calculate and log opt-out filter rate percentage
        </enhancement>
        <verification>
          - Test log output manually with sample data
          - Document log format in docs/analytics/scheduler-metrics.md
        </verification>
      </task>
    </task-breakdown>

    <documentation-structure>
      <directory path="docs/analytics">
        <file name="engagement-preferences.md" description="PostHog queries"/>
        <file name="sql-queries.md" description="Database queries"/>
        <file name="scheduler-metrics.md" description="Scheduler logs"/>
        <file name="dashboard-setup.md" description="Setup guide"/>
      </directory>
      <directory path="scripts/analytics">
        <file name="sample-queries.sql" description="Executable queries"/>
        <file name="check-optout-spike.ts" description="Monitoring script"/>
      </directory>
    </documentation-structure>

    <performance-considerations>
      <database-queries>
        <note>Opt-out rate query is cheap (single table scan with filter)</note>
        <recommendation>For &gt;10k users, add index: CREATE INDEX idx_reengagement_opt_out ON user_profiles(reengagement_opt_out);</recommendation>
        <recommendation>Run analytics queries against read replica if available (reduce main DB load)</recommendation>
      </database-queries>

      <posthog-queries>
        <note>PostHog handles large event volumes efficiently</note>
        <recommendation>Use date range filters to limit query scope</recommendation>
        <recommendation>Dashboard auto-refresh can be set to 5-minute intervals</recommendation>
      </posthog-queries>

      <scheduler-logs>
        <note>Structured JSON logs enable efficient parsing</note>
        <note>Railway/CloudWatch log search is fast for recent logs</note>
        <recommendation>Archive old logs if storage costs become concern</recommendation>
      </scheduler-logs>
    </performance-considerations>

    <alerting-strategy>
      <alert name="Opt-out rate spike" severity="CRITICAL">
        <condition>Opt-out rate &gt; 20% in 24 hours</condition>
        <action>Review message tone and frequency in Epic 4-5</action>
        <implementation>Task 5 monitoring script</implementation>
        <channels>
          <channel>Console logs (always)</channel>
          <channel>Email (optional, configure SMTP)</channel>
          <channel>Slack webhook (optional, configure webhook URL)</channel>
        </channels>
      </alert>

      <alert name="Scheduler fails to respect opt-out" severity="CRITICAL">
        <condition>Opted-out user receives message</condition>
        <action>LGPD violation, user trust broken</action>
        <implementation>Story 6.4 tests (already implemented)</implementation>
        <note>Comprehensive test coverage prevents this scenario</note>
      </alert>
    </alerting-strategy>

    <lgpd-compliance>
      <data-retention>
        <source>PostHog events</source>
        <retention>90 days (configurable)</retention>
      </data-retention>
      <data-retention>
        <source>Database state</source>
        <retention>Indefinite (current preference)</retention>
      </data-retention>
      <data-retention>
        <source>Scheduler logs</source>
        <retention>30 days</retention>
      </data-retention>

      <privacy>
        <note>Analytics queries use user_id (UUID), not PII</note>
        <note>No sensitive data in logs or events</note>
        <note>Aggregate metrics only (no individual user targeting)</note>
      </privacy>
    </lgpd-compliance>
  </implementation-guidance>

  <testing-strategy>
    <unit-tests>
      <test-file path="whatsapp-bot/src/__tests__/analytics/posthog-events.test.ts" status="NEW">
        <test>PostHog event schema validation</test>
        <test>Event name is 'engagement_preference_changed'</test>
        <test>Required properties present: user_id, preference, source, timestamp</test>
        <test>Property types are correct</test>
        <test>Source is either 'whatsapp' or 'web'</test>
        <test>Preference is either 'opted_in' or 'opted_out'</test>
      </test-file>

      <test-file path="scripts/analytics/__tests__/check-optout-spike.test.ts" status="NEW">
        <test>Spike detection: opt-out rate &gt; 20% triggers alert</test>
        <test>No spike: opt-out rate &lt; 20% logs info</test>
        <test>Calculation: (opt_outs / total_users) * 100 is correct</test>
        <test>Error handling: PostHog query failure</test>
        <test>Error handling: Database query failure</test>
      </test-file>
    </unit-tests>

    <integration-tests>
      <test-file path="whatsapp-bot/src/__tests__/integration/analytics-flow.test.ts" status="NEW">
        <test>Opt-out via WhatsApp → PostHog event tracked with source: 'whatsapp'</test>
        <test>Opt-out via web → PostHog event tracked with source: 'web'</test>
        <test>Database query returns correct opt-out count</test>
        <test>Scheduler logs include opt-out metrics</test>
      </test-file>
    </integration-tests>

    <manual-verification>
      <checklist>
        <item>Run sample SQL queries against staging database</item>
        <item>Access PostHog dashboard and verify charts load</item>
        <item>Trigger spike detection script manually</item>
        <item>Review scheduler logs for proper format</item>
        <item>Verify documentation accuracy (all links work, queries execute)</item>
        <item>Test Railway log access via CLI and web UI</item>
      </checklist>
    </manual-verification>
  </testing-strategy>

  <cross-story-dependencies>
    <dependency type="completed" story-id="6-1">
      <title>WhatsApp Opt-Out/Opt-In Commands</title>
      <provides>PostHog event tracking with source: 'whatsapp'</provides>
      <location>whatsapp-bot/src/handlers/engagement/opt-out-handler.ts</location>
    </dependency>

    <dependency type="completed" story-id="6-2">
      <title>Web Settings Opt-Out Toggle</title>
      <provides>PostHog event tracking with source: 'web'</provides>
      <location>fe/app/[locale]/settings/account/page.tsx</location>
    </dependency>

    <dependency type="completed" story-id="6-4">
      <title>Opt-Out Respect in Engagement System</title>
      <provides>Scheduler opt-out filtering logic</provides>
      <location>whatsapp-bot/src/services/scheduler/*.ts</location>
    </dependency>

    <dependency type="completed" story-id="5-1">
      <title>Daily Engagement Job</title>
      <provides>Daily scheduler job with opt-out filtering</provides>
      <enhancement>Add structured logging for opt-out metrics</enhancement>
    </dependency>

    <dependency type="completed" story-id="5-3">
      <title>Weekly Review Job</title>
      <provides>Weekly scheduler job with opt-out filtering</provides>
      <enhancement>Add structured logging for opt-out metrics</enhancement>
    </dependency>
  </cross-story-dependencies>

  <file-checklist>
    <files-to-create>
      <file path="docs/analytics/engagement-preferences.md">PostHog documentation</file>
      <file path="docs/analytics/sql-queries.md">Database queries</file>
      <file path="docs/analytics/scheduler-metrics.md">Scheduler logs</file>
      <file path="docs/analytics/dashboard-setup.md">Setup guide</file>
      <file path="scripts/analytics/sample-queries.sql">Executable SQL</file>
      <file path="scripts/analytics/check-optout-spike.ts">Monitoring script</file>
      <file path="whatsapp-bot/src/__tests__/analytics/posthog-events.test.ts">Event schema tests</file>
    </files-to-create>

    <files-to-modify>
      <file path="README.md">Add Analytics &amp; Monitoring section</file>
      <file path="whatsapp-bot/src/services/scheduler/daily-engagement-job.ts">Add structured logging</file>
      <file path="whatsapp-bot/src/services/scheduler/weekly-review-job.ts">Add structured logging</file>
      <file path=".env.example">Add alert configuration options</file>
      <file path="railway.cron.yml">Add spike detection cron job (optional)</file>
    </files-to-modify>
  </file-checklist>

  <implementation-notes>
    <note priority="high">
      This is a DOCUMENTATION-HEAVY story with minimal code changes.
      Focus is on making analytics data accessible through clear docs, sample queries, and monitoring scripts.
    </note>

    <note priority="high">
      PostHog event schema MUST match implementation in Stories 6.1 and 6.2.
      Verify event properties by inspecting existing tracking calls.
    </note>

    <note priority="medium">
      Scheduler logging enhancements are OPTIONAL but RECOMMENDED.
      Current logs include basic info; adding structured opt-out metrics improves observability.
    </note>

    <note priority="medium">
      Spike detection script should be lightweight and fast (&lt;5s execution).
      Use PostHog's query API efficiently with date range filters.
    </note>

    <note priority="low">
      Documentation should be clear enough for non-technical product owners to use.
      Include screenshots, step-by-step guides, and troubleshooting sections.
    </note>
  </implementation-notes>

  <definition-of-done>
    <item>PostHog event schema documented with sample queries</item>
    <item>SQL queries created for all key metrics</item>
    <item>Scheduler log format documented with parsing examples</item>
    <item>Analytics dashboard setup guide created</item>
    <item>Opt-out spike detection script implemented</item>
    <item>Sample queries file created with executable SQL</item>
    <item>README updated with Analytics section</item>
    <item>PostHog event schema validation tests passing</item>
    <item>Scheduler logging enhancements implemented (if applicable)</item>
    <item>All documentation links work and queries execute correctly</item>
    <item>Manual QA checklist completed</item>
    <item>Story marked as ready-for-dev in sprint-status.yaml</item>
  </definition-of-done>

  <references>
    <reference type="tech-spec">
      docs/sprint-artifacts/tech-spec-epic-6.md#AC-6.5-Analytics-Dashboard-Access
    </reference>
    <reference type="tech-spec">
      docs/sprint-artifacts/tech-spec-epic-6.md#Observability
    </reference>
    <reference type="tech-spec">
      docs/sprint-artifacts/tech-spec-epic-6.md#Key-Metrics-to-Monitor
    </reference>
    <reference type="related-story">
      docs/sprint-artifacts/6-1-whatsapp-opt-out-opt-in-commands.md#PostHog-Event-Schema
    </reference>
    <reference type="related-story">
      docs/sprint-artifacts/6-2-web-settings-opt-out-toggle.md#Analytics-Tracking
    </reference>
    <reference type="project-docs">
      CLAUDE.md#WhatsApp-Bot-Message-Flow
    </reference>
  </references>
</story-context>
