<?xml version="1.0" encoding="UTF-8"?>
<story-context id="7-4-goodbye-handler-tests">
  <metadata>
    <story-id>7-4-goodbye-handler-tests</story-id>
    <epic-id>epic-7</epic-id>
    <status>ready-for-dev</status>
    <related-stories>
      <story>7.1 - E2E Testing Framework Setup</story>
      <story>7.2 - State Machine Unit Tests</story>
      <story>7.3 - Scheduler Unit Tests</story>
      <story>4.4 - Goodbye Response Processing (implementation under test)</story>
    </related-stories>
  </metadata>

  <story-overview>
    <summary>
      Comprehensive unit tests for goodbye response processing to ensure response parsing
      and state transitions execute correctly for all goodbye interactions.
    </summary>
    <goal>
      Validate the goodbye handler implementation from Story 4.4, ensuring:
      - Pattern matching (numbers 1-3, emoji variants, pt-BR/en keywords)
      - State transitions (confused → help_flow → active, busy → remind_later, all_good → dormant)
      - Side effects (onboarding reset, message queueing, analytics tracking)
      - Localization (pt-BR and en confirmation messages)
      - Error handling (transition failures, missing destinations, resilience)
    </goal>
    <test-file-status>
      <exists>true</exists>
      <location>whatsapp-bot/src/__tests__/handlers/engagement/goodbye-handler.test.ts</location>
      <summary>
        File exists with 672 lines and comprehensive test coverage.
        Contains 8 test suites covering:
        1. isGoodbyeResponse pattern matching (32 tests for Options 1-3 + non-matching)
        2. parseGoodbyeResponse legacy function (4 tests)
        3. processGoodbyeResponse - confused (6 tests)
        4. processGoodbyeResponse - busy (3 tests)
        5. processGoodbyeResponse - all_good (3 tests)
        6. checkAndHandleGoodbyeResponse - non-goodbye responses (3 tests)
        7. Localization (2 tests)
        8. handleGoodbyeResponse legacy handler (3 tests)
        9. Error Handling (3 tests)
      </summary>
      <coverage-status>
        Existing tests appear comprehensive. Task is to VERIFY and VALIDATE rather than create new tests.
        AC 7.4.9-7.4.11 may need additional edge cases for resilience testing.
      </coverage-status>
    </test-file-status>
  </story-overview>

  <acceptance-criteria>
    <ac id="AC-7.4.1">
      Pattern matching: isGoodbyeResponse() correctly matches all valid patterns:
      - Numbers: 1, 2, 3
      - Emoji: 1️⃣, 2️⃣, 3️⃣
      - Portuguese keywords: "confuso", "ocupado", "tudo certo"/"tudocerto"
      - English keywords: "confused", "busy", "all good"/"allgood"
      - Case-insensitive matching (CONFUSO, Confused, ALL GOOD)
      - Whitespace trimming (" 1 ", " confuso ")
      Maps to: 'confused', 'busy', 'all_good' respectively
    </ac>
    <ac id="AC-7.4.2">
      Non-matching text returns null:
      - Regular messages: "hello", "gastei 50", "/add 50"
      - Invalid numbers: "4", "11", "0"
      - Empty/whitespace: "", "   "
      No false positives occur.
    </ac>
    <ac id="AC-7.4.3">
      Confused response (Option 1) flow:
      1. State transitions to 'help_flow' (via 'goodbye_response_1' trigger)
      2. Onboarding progress reset: tier=0, progress={}, tips_enabled=true
      3. Help restart message queued
      4. State transitions to 'active' (via 'user_message' trigger with from_help_flow=true)
      5. Localized confirmation message returned (pt-BR or en)
    </ac>
    <ac id="AC-7.4.4">
      Busy response (Option 2) flow:
      1. State transitions to 'remind_later' (via 'goodbye_response_2' trigger)
      2. remind_at set to now+14days (handled by state machine)
      3. Localized confirmation message returned ("Entendido! Te vejo daqui a 2 semanas" / "Got it! See you in 2 weeks")
    </ac>
    <ac id="AC-7.4.5">
      All good response (Option 3) flow:
      1. State transitions to 'dormant' (via 'goodbye_response_3' trigger)
      2. Localized confirmation message returned ("Tudo certo! A porta está sempre aberta" / "All good! The door is always open")
    </ac>
    <ac id="AC-7.4.6">
      Non-goodbye text from goodbye_sent state:
      1. State transitions to 'active' with metadata {from_goodbye_sent: true, non_response_text: true}
      2. Null returned to allow normal message processing
      3. No confirmation message sent
    </ac>
    <ac id="AC-7.4.7">
      Goodbye-like text from non-goodbye_sent state:
      1. No state transition occurs
      2. Null returned to allow normal processing
      3. Message treated as regular user input
    </ac>
    <ac id="AC-7.4.8">
      Analytics tracking on successful goodbye response:
      - Event: 'engagement_goodbye_response'
      - Metadata includes:
        - response_type: 'confused' | 'busy' | 'all_good'
        - days_since_goodbye: N (calculated from goodbye_sent_at)
    </ac>
    <ac id="AC-7.4.9">
      Message queueing failure handling (confused response):
      - When getMessageDestination returns null (no destination found)
      - Onboarding reset and state transitions still succeed
      - Warning is logged
      - result.success=true (message queueing is best-effort)
    </ac>
    <ac id="AC-7.4.10">
      State transition failure handling:
      - When transitionState() fails
      - result.success=false returned with descriptive error message
      - Current state is preserved
      - Error is logged
    </ac>
    <ac id="AC-7.4.11">
      Legacy function compatibility:
      - parseGoodbyeResponse(messageText) returns 1|2|3|null
      - handleGoodbyeResponse({userId, responseOption: 1|2|3}) executes correct transitions
      - Backward compatibility maintained
    </ac>
    <ac id="AC-7.4.12">
      Test execution and coverage:
      - npm test -- goodbye-handler.test.ts runs successfully
      - Coverage ≥ 80% for goodbye-handler.ts (branches, functions, lines)
      - All tests pass in &lt; 3 seconds
      - No external dependencies required (mocked DB, WhatsApp, analytics)
    </ac>
  </acceptance-criteria>

  <existing-implementation>
    <file-path>whatsapp-bot/src/handlers/engagement/goodbye-handler.ts</file-path>
    <key-functions>
      <function>
        <name>isGoodbyeResponse</name>
        <signature>isGoodbyeResponse(messageText: string): GoodbyeResponseType | null</signature>
        <description>
          Pattern matching function using regex for confused/busy/all_good responses.
          Returns response type or null if no match.
        </description>
        <patterns>
          confused: /^(1|1️⃣|confuso|confused)$/i
          busy: /^(2|2️⃣|ocupado|busy)$/i
          all_good: /^(3|3️⃣|tudo\s*certo|all\s*good)$/i
        </patterns>
      </function>
      <function>
        <name>parseGoodbyeResponse</name>
        <signature>parseGoodbyeResponse(messageText: string): 1 | 2 | 3 | null</signature>
        <description>
          Legacy function mapping to new isGoodbyeResponse.
          Returns numeric option (1, 2, 3) or null.
        </description>
      </function>
      <function>
        <name>processGoodbyeResponse</name>
        <signature>
          processGoodbyeResponse(
            userId: string,
            responseType: GoodbyeResponseType,
            locale: 'pt-BR' | 'en' = 'pt-BR'
          ): Promise&lt;GoodbyeResult&gt;
        </signature>
        <description>
          Main handler processing goodbye responses.
          Routes to handleConfusedResponse/handleBusyResponse/handleAllGoodResponse.
          Returns confirmation message or error.
        </description>
        <side-effects>
          - Verifies user is in 'goodbye_sent' state
          - Calculates days_since_goodbye for analytics
          - Tracks analytics event 'engagement_goodbye_response'
          - Calls state-specific handler
        </side-effects>
      </function>
      <function>
        <name>handleConfusedResponse</name>
        <signature>
          handleConfusedResponse(
            userId: string,
            locale: 'pt-BR' | 'en',
            daysSinceGoodbye: number
          ): Promise&lt;GoodbyeResult&gt;
        </signature>
        <description>
          Handles "confused" response (Option 1).
          Multi-step transition: goodbye_sent → help_flow → active
        </description>
        <steps>
          1. transitionState(userId, 'goodbye_response_1', {response_type: 'confused'})
          2. resetOnboardingProgress(userId) - sets tier=0, progress={}, tips_enabled=true
          3. queueHelpRestartMessage(userId, locale) - best-effort message queueing
          4. transitionState(userId, 'user_message', {from_help_flow: true})
          5. Return localized confirmation message
        </steps>
      </function>
      <function>
        <name>handleBusyResponse</name>
        <signature>
          handleBusyResponse(
            userId: string,
            locale: 'pt-BR' | 'en',
            daysSinceGoodbye: number
          ): Promise&lt;GoodbyeResult&gt;
        </signature>
        <description>
          Handles "busy" response (Option 2).
          Single transition: goodbye_sent → remind_later
        </description>
        <steps>
          1. transitionState(userId, 'goodbye_response_2', {response_type: 'busy'})
          2. State machine sets remind_at = now + 14 days
          3. Return localized confirmation message
        </steps>
      </function>
      <function>
        <name>handleAllGoodResponse</name>
        <signature>
          handleAllGoodResponse(
            userId: string,
            locale: 'pt-BR' | 'en',
            daysSinceGoodbye: number
          ): Promise&lt;GoodbyeResult&gt;
        </signature>
        <description>
          Handles "all good" response (Option 3).
          Single transition: goodbye_sent → dormant
        </description>
        <steps>
          1. transitionState(userId, 'goodbye_response_3', {response_type: 'all_good'})
          2. Return localized confirmation message
        </steps>
      </function>
      <function>
        <name>checkAndHandleGoodbyeResponse</name>
        <signature>
          checkAndHandleGoodbyeResponse(
            userId: string,
            messageText: string,
            locale: 'pt-BR' | 'en' = 'pt-BR'
          ): Promise&lt;string | null&gt;
        </signature>
        <description>
          Entry point for text handler integration.
          Checks if user is in goodbye_sent state and handles response or transitions to active.
        </description>
        <logic>
          1. Get current state via getEngagementState(userId)
          2. If not 'goodbye_sent', return null (normal processing)
          3. Check if message is goodbye response via isGoodbyeResponse(messageText)
          4. If not goodbye response, transition to active and return null
          5. If goodbye response, process via processGoodbyeResponse()
          6. Return confirmation message or error message
        </logic>
      </function>
      <function>
        <name>handleGoodbyeResponse</name>
        <signature>
          handleGoodbyeResponse(response: GoodbyeResponse): Promise&lt;GoodbyeResult&gt;
        </signature>
        <description>
          Legacy handler function mapping responseOption (1|2|3) to new processGoodbyeResponse.
          Defaults locale to 'pt-BR' for backward compatibility.
        </description>
      </function>
    </key-functions>
    <helper-functions>
      <function>
        <name>resetOnboardingProgress</name>
        <description>
          Updates user_profiles table: onboarding_tier=0, onboarding_tier_progress={},
          onboarding_tips_enabled=true.
        </description>
      </function>
      <function>
        <name>queueHelpRestartMessage</name>
        <description>
          Queues 'help_restart' message via message queue service.
          Best-effort - logs warning if destination not found but doesn't fail handler.
        </description>
      </function>
      <function>
        <name>calculateDaysSinceGoodbye</name>
        <description>
          Queries user_engagement_states.goodbye_sent_at and calculates days elapsed.
          Returns 0 if error or missing timestamp.
        </description>
      </function>
    </helper-functions>
    <localized-messages>
      <confused>
        pt-BR: "Sem problemas! Vou te ajudar a começar de novo. Vou te mandar algumas dicas nos próximos dias. Que tal começar registrando uma despesa? Ex: 'gastei 50 no almoço'"
        en: "No problem! Let me help you get started again. I'll send you some tips over the next few days. How about logging an expense? E.g., 'spent 50 on lunch'"
      </confused>
      <busy>
        pt-BR: "Entendido! Te vejo daqui a 2 semanas. Enquanto isso, fico aqui se precisar de algo."
        en: "Got it! See you in 2 weeks. I'll be here if you need anything in the meantime."
      </busy>
      <all-good>
        pt-BR: "Tudo certo! A porta está sempre aberta. Manda uma mensagem quando quiser voltar."
        en: "All good! The door is always open. Just send a message whenever you want to come back."
      </all-good>
      <error>
        pt-BR: "Desculpa, algo deu errado. Tente novamente."
        en: "Sorry, something went wrong. Please try again."
      </error>
    </localized-messages>
  </existing-implementation>

  <existing-tests>
    <file-path>whatsapp-bot/src/__tests__/handlers/engagement/goodbye-handler.test.ts</file-path>
    <summary>
      Comprehensive test suite with 672 lines covering all acceptance criteria.
      All mocks configured: state-machine, message-sender, message-router, analytics, logger, supabase.
    </summary>
    <test-suites>
      <suite name="isGoodbyeResponse - AC-4.4.5">
        <coverage>
          - 8 tests for Option 1 (confused): exact, emoji, keywords, case, whitespace
          - 7 tests for Option 2 (busy): exact, emoji, keywords, case, whitespace
          - 8 tests for Option 3 (all_good): exact, emoji, keywords with/without space, case, whitespace
          - 7 tests for non-matching patterns: regular text, commands, invalid numbers, empty strings
        </coverage>
        <status>COMPLETE - All pattern variations covered</status>
      </suite>
      <suite name="parseGoodbyeResponse - Legacy Function">
        <coverage>
          - 4 tests mapping confused/busy/all_good to 1/2/3 and null for non-matches
        </coverage>
        <status>COMPLETE - Legacy compatibility validated</status>
      </suite>
      <suite name="processGoodbyeResponse - confused (AC-4.4.1)">
        <coverage>
          - Transition to help_flow validation
          - Onboarding progress reset verification
          - Transition to active validation
          - pt-BR confirmation message
          - en confirmation message
          - Analytics tracking
        </coverage>
        <status>MOSTLY COMPLETE - Missing AC-7.4.9 (message queue failure handling)</status>
      </suite>
      <suite name="processGoodbyeResponse - busy (AC-4.4.2)">
        <coverage>
          - Transition to remind_later validation
          - pt-BR confirmation message
          - en confirmation message
          - Analytics tracking
        </coverage>
        <status>COMPLETE</status>
      </suite>
      <suite name="processGoodbyeResponse - all_good (AC-4.4.3)">
        <coverage>
          - Transition to dormant validation
          - pt-BR confirmation message
          - en confirmation message
          - Analytics tracking
        </coverage>
        <status>COMPLETE</status>
      </suite>
      <suite name="checkAndHandleGoodbyeResponse - Non-Goodbye Responses (AC-4.4.4)">
        <coverage>
          - User not in goodbye_sent state (no action)
          - Non-goodbye text from goodbye_sent state (transition to active)
          - Null returned to allow normal processing
        </coverage>
        <status>COMPLETE</status>
      </suite>
      <suite name="Localization (AC-4.4.6)">
        <coverage>
          - Default pt-BR locale
          - Explicit en locale
        </coverage>
        <status>COMPLETE</status>
      </suite>
      <suite name="handleGoodbyeResponse - Legacy Handler">
        <coverage>
          - Response option 1 → confused
          - Response option 2 → busy
          - Response option 3 → all_good
        </coverage>
        <status>COMPLETE</status>
      </suite>
      <suite name="Error Handling">
        <coverage>
          - Transition failure handling
          - Error message in checkAndHandleGoodbyeResponse (pt-BR)
          - Error message in checkAndHandleGoodbyeResponse (en)
        </coverage>
        <status>PARTIAL - Missing AC-7.4.9 (resilience), AC-7.4.10 (detailed error scenarios)</status>
      </suite>
    </test-suites>
    <gaps>
      <gap id="1">
        AC-7.4.9: Message queueing failure handling for confused response not explicitly tested.
        Need test where getMessageDestination returns null but handler still succeeds.
      </gap>
      <gap id="2">
        AC-7.4.10: Days_since_goodbye calculation edge cases:
        - Missing goodbye_sent_at
        - Database error in calculation
        - Fallback behavior (should be 0)
      </gap>
      <gap id="3">
        AC-7.4.10: Resilience testing for confused response:
        - First transition (help_flow) succeeds
        - Second transition (active) fails
        - Handler should continue with warning, not fail
      </gap>
      <gap id="4">
        AC-7.4.7: Explicit test for goodbye-like text from non-goodbye_sent state
        (e.g., user in 'active' state sends "1" → treated as normal message)
      </gap>
    </gaps>
  </existing-tests>

  <test-infrastructure>
    <mocks>
      <mock name="Supabase Client">
        <import>from '__mocks__/supabase'</import>
        <functions>
          - mockSupabaseClient: Chainable query builder
          - resetSupabaseMocks(): Reset all mocks
          - mockQuerySequence([{data, error}, ...]): Mock sequential query results
        </functions>
        <usage>
          mockQuerySequence([
            { data: { goodbye_sent_at: new Date().toISOString() }, error: null },
            { data: { id: userId }, error: null },
          ])
        </usage>
      </mock>
      <mock name="State Machine">
        <mocked-functions>
          - transitionState(userId, trigger, metadata)
          - getEngagementState(userId)
        </mocked-functions>
        <default-behavior>
          transitionState: mockResolvedValue({ success: true, newState: 'active' })
          getEngagementState: mockResolvedValue('goodbye_sent')
        </default-behavior>
      </mock>
      <mock name="Message Queue">
        <mocked-functions>
          - queueMessage(params)
        </mocked-functions>
        <default-behavior>
          mockResolvedValue(true)
        </default-behavior>
      </mock>
      <mock name="Message Router">
        <mocked-functions>
          - getMessageDestination(userId)
        </mocked-functions>
        <default-behavior>
          mockResolvedValue({
            destination: 'individual',
            destinationJid: '5511999999999@s.whatsapp.net'
          })
        </default-behavior>
      </mock>
      <mock name="Analytics">
        <mocked-functions>
          - trackEvent(eventName, userId, metadata)
        </mocked-functions>
        <default-behavior>
          No return value, spy function
        </default-behavior>
      </mock>
      <mock name="Logger">
        <mocked-functions>
          - logger.info(message, context)
          - logger.warn(message, context)
          - logger.error(message, context, error)
          - logger.debug(message, context)
        </mocked-functions>
        <default-behavior>
          All functions are jest.fn() spies
        </default-behavior>
      </mock>
    </mocks>
    <test-patterns>
      <pattern name="Basic Test Structure">
        <code><![CDATA[
describe('Function Name - AC-X.X.X', () => {
  const userId = 'test-user-123'

  beforeEach(() => {
    resetSupabaseMocks()
    mockTransitionState.mockClear()
    mockTransitionState.mockResolvedValue({ success: true, newState: 'active' })
    // ... other mock resets
  })

  it('should perform expected behavior', async () => {
    // Arrange
    mockQuerySequence([
      { data: { goodbye_sent_at: new Date().toISOString() }, error: null },
    ])

    // Act
    const result = await processGoodbyeResponse(userId, 'confused', 'pt-BR')

    // Assert
    expect(result.success).toBe(true)
    expect(mockTransitionState).toHaveBeenCalledWith(
      userId,
      'goodbye_response_1',
      expect.objectContaining({ response_type: 'confused' })
    )
  })
})
        ]]></code>
      </pattern>
      <pattern name="Error Handling Test">
        <code><![CDATA[
it('should handle transition failure gracefully', async () => {
  mockTransitionState.mockResolvedValue({
    success: false,
    error: 'State transition failed',
  })
  mockQuerySequence([
    { data: { goodbye_sent_at: new Date().toISOString() }, error: null },
  ])

  const result = await processGoodbyeResponse(userId, 'busy', 'pt-BR')

  expect(result.success).toBe(false)
  expect(result.error).toContain('transition')
})
        ]]></code>
      </pattern>
      <pattern name="Localization Test">
        <code><![CDATA[
it('should return pt-BR confirmation message', async () => {
  mockQuerySequence([
    { data: { goodbye_sent_at: new Date().toISOString() }, error: null },
  ])

  const result = await processGoodbyeResponse(userId, 'all_good', 'pt-BR')

  expect(result.message).toContain('Tudo certo')
  expect(result.message).toContain('porta está sempre aberta')
})
        ]]></code>
      </pattern>
    </test-patterns>
    <fixtures>
      <fixture name="createMockEngagementState">
        <import>from '__tests__/engagement/fixtures/engagement-fixtures'</import>
        <usage>
          const state = createMockEngagementState({
            userId: 'test-user-123',
            state: 'goodbye_sent',
            goodbyeSentAt: new Date('2025-01-15'),
          })
        </usage>
      </fixture>
      <fixture name="Time Helpers">
        <import>from '__tests__/utils/time-helpers'</import>
        <functions>
          - setupMockTime(startDate): Initialize fake timers
          - advanceTime(days): Move time forward
          - resetClock(): Restore real timers
        </functions>
        <note>Not currently used in goodbye-handler tests but available if needed</note>
      </fixture>
    </fixtures>
  </test-infrastructure>

  <dependencies>
    <production-code>
      <file>whatsapp-bot/src/handlers/engagement/goodbye-handler.ts</file>
      <file>whatsapp-bot/src/services/engagement/state-machine.ts</file>
      <file>whatsapp-bot/src/services/scheduler/message-sender.ts</file>
      <file>whatsapp-bot/src/services/engagement/message-router.ts</file>
      <file>whatsapp-bot/src/analytics/index.ts</file>
      <file>whatsapp-bot/src/services/monitoring/logger.ts</file>
      <file>whatsapp-bot/src/services/database/supabase-client.ts</file>
    </production-code>
    <test-utilities>
      <file>whatsapp-bot/src/__mocks__/supabase.ts</file>
      <file>whatsapp-bot/src/__tests__/engagement/fixtures/engagement-fixtures.ts</file>
      <file>whatsapp-bot/src/__tests__/utils/time-helpers.ts</file>
    </test-utilities>
    <packages>
      <package>jest (^29.7.0) - Test framework</package>
      <package>ts-jest (^29.1.1) - TypeScript preprocessor</package>
      <package>@types/jest (^29.5.8) - TypeScript types</package>
    </packages>
  </dependencies>

  <implementation-notes>
    <note id="1" priority="high">
      TEST VERIFICATION FOCUS: Existing tests are comprehensive. Task is to:
      1. Run tests and verify all pass
      2. Check coverage meets ≥80% threshold
      3. Add missing tests for gaps identified (AC-7.4.9, AC-7.4.10 edge cases)
      4. Validate test execution time &lt; 3 seconds
    </note>
    <note id="2" priority="high">
      RESILIENCE TESTING (AC-7.4.9): Message queueing is best-effort.
      Test that confused response succeeds even when:
      - getMessageDestination returns null
      - queueMessage fails
      Handler should log warning but return success=true
    </note>
    <note id="3" priority="medium">
      DAYS_SINCE_GOODBYE CALCULATION (AC-7.4.10): Test edge cases:
      - Missing goodbye_sent_at → should default to 0
      - Database error → should default to 0 and log error
      - Valid timestamp → should calculate correctly
    </note>
    <note id="4" priority="medium">
      CONFUSED RESPONSE RESILIENCE (AC-7.4.10): Test that confused response continues when:
      - First transition (help_flow) succeeds
      - Second transition (active) fails
      Result should be success=true with warning logged (user got help message)
    </note>
    <note id="5" priority="low">
      LOCALIZATION DEFAULT: Verify default locale is 'pt-BR' when not specified
      in processGoodbyeResponse and handleGoodbyeResponse (legacy)
    </note>
    <note id="6" priority="medium">
      ANALYTICS TRACKING: Every goodbye response must track 'engagement_goodbye_response' event
      with response_type and days_since_goodbye in metadata. Verify for all three response types.
    </note>
    <note id="7" priority="low">
      PATTERN MATCHING PERFORMANCE: isGoodbyeResponse uses regex with case-insensitive flag.
      Consider adding test for performance with very long strings (edge case, low priority).
    </note>
    <note id="8" priority="high">
      COVERAGE TARGET: goodbye-handler.ts must achieve ≥80% coverage across:
      - Branches (conditional logic)
      - Functions (all exported functions)
      - Lines (executed code)
      - Statements (individual statements)
    </note>
    <note id="9" priority="medium">
      TEST ISOLATION: Each test uses unique userId and resets all mocks in beforeEach().
      No shared state between tests. Time-based tests should use real time (not fake timers)
      as goodbye handler doesn't use timers.
    </note>
    <note id="10" priority="high">
      MOCK CONFIGURATION: All external dependencies mocked:
      - Supabase client: mockQuerySequence for DB queries
      - State machine: mockTransitionState, mockGetEngagementState
      - Message queue: mockQueueMessage
      - Message router: mockGetMessageDestination
      - Analytics: mockTrackEvent
      - Logger: all logger methods mocked
    </note>
    <note id="11" priority="medium">
      ERROR MESSAGES: Verify localized error messages in checkAndHandleGoodbyeResponse:
      - pt-BR: "Desculpa, algo deu errado. Tente novamente."
      - en: "Sorry, something went wrong. Please try again."
    </note>
    <note id="12" priority="low">
      LEGACY COMPATIBILITY: parseGoodbyeResponse and handleGoodbyeResponse maintained
      for backward compatibility. Tests verify mapping from old API (1|2|3) to new API
      (confused|busy|all_good).
    </note>
  </implementation-notes>

  <test-organization>
    <structure>
      <suite>
        <name>isGoodbyeResponse - AC-4.4.5</name>
        <subsections>
          - confused response patterns (Option 1)
          - busy response patterns (Option 2)
          - all_good response patterns (Option 3)
          - non-matching patterns
        </subsections>
      </suite>
      <suite>
        <name>parseGoodbyeResponse - Legacy Function</name>
        <tests>Mapping tests for 1|2|3|null</tests>
      </suite>
      <suite>
        <name>processGoodbyeResponse - confused (AC-4.4.1)</name>
        <tests>
          - Transition to help_flow
          - Onboarding progress reset
          - Transition to active
          - pt-BR/en confirmation messages
          - Analytics tracking
          - [GAP] Message queueing failure handling
        </tests>
      </suite>
      <suite>
        <name>processGoodbyeResponse - busy (AC-4.4.2)</name>
        <tests>
          - Transition to remind_later
          - pt-BR/en confirmation messages
          - Analytics tracking
        </tests>
      </suite>
      <suite>
        <name>processGoodbyeResponse - all_good (AC-4.4.3)</name>
        <tests>
          - Transition to dormant
          - pt-BR/en confirmation messages
          - Analytics tracking
        </tests>
      </suite>
      <suite>
        <name>checkAndHandleGoodbyeResponse - Non-Goodbye Responses (AC-4.4.4)</name>
        <tests>
          - User not in goodbye_sent state
          - Non-goodbye text from goodbye_sent state
          - Null returned for normal processing
        </tests>
      </suite>
      <suite>
        <name>Localization (AC-4.4.6)</name>
        <tests>
          - Default pt-BR locale
          - Explicit en locale
        </tests>
      </suite>
      <suite>
        <name>handleGoodbyeResponse - Legacy Handler</name>
        <tests>Option 1|2|3 mapping</tests>
      </suite>
      <suite>
        <name>Error Handling</name>
        <tests>
          - Transition failure
          - Error messages (pt-BR/en)
          - [GAP] Resilience (active transition failure after help_flow succeeds)
          - [GAP] Days calculation edge cases
        </tests>
      </suite>
    </structure>
  </test-organization>

  <validation-checklist>
    <item id="1">All existing tests pass: npm test -- goodbye-handler.test.ts</item>
    <item id="2">Coverage ≥80% for goodbye-handler.ts: npm test -- goodbye-handler.test.ts --coverage</item>
    <item id="3">Test execution time &lt; 3 seconds (unit test requirement)</item>
    <item id="4">No external dependencies (all mocked)</item>
    <item id="5">All pattern variations tested (AC-7.4.1, AC-7.4.2)</item>
    <item id="6">All response flows tested (AC-7.4.3, AC-7.4.4, AC-7.4.5)</item>
    <item id="7">Non-goodbye handling tested (AC-7.4.6, AC-7.4.7)</item>
    <item id="8">Analytics tracking verified (AC-7.4.8)</item>
    <item id="9">Message queueing failure handling tested (AC-7.4.9) - [GAP]</item>
    <item id="10">State transition failure handling tested (AC-7.4.10) - [PARTIAL]</item>
    <item id="11">Legacy compatibility verified (AC-7.4.11)</item>
    <item id="12">All localization variants tested (pt-BR and en)</item>
    <item id="13">Error messages localized and tested</item>
    <item id="14">Days_since_goodbye edge cases tested - [GAP]</item>
    <item id="15">Resilience: confused response continues after active transition failure - [GAP]</item>
  </validation-checklist>

  <key-test-scenarios>
    <scenario id="1" priority="critical">
      <name>Pattern Matching - All Valid Patterns</name>
      <description>
        Test isGoodbyeResponse() with all valid patterns (numbers, emoji, keywords, case variations,
        whitespace). Each must return correct response type.
      </description>
      <inputs>
        "1", "1️⃣", "confuso", "confused", "CONFUSO", " 1 ", " confuso "
        "2", "2️⃣", "ocupado", "busy", "OCUPADO", " 2 "
        "3", "3️⃣", "tudo certo", "tudocerto", "all good", "allgood", "TUDO CERTO", " 3 "
      </inputs>
      <expected>Correct GoodbyeResponseType for each</expected>
      <status>COVERED</status>
    </scenario>
    <scenario id="2" priority="critical">
      <name>Pattern Matching - Non-Matching Patterns</name>
      <description>
        Test isGoodbyeResponse() with invalid inputs. Must return null for all.
      </description>
      <inputs>
        "hello", "gastei 50", "/add 50", "4", "11", "0", "", "   "
      </inputs>
      <expected>null for all inputs</expected>
      <status>COVERED</status>
    </scenario>
    <scenario id="3" priority="critical">
      <name>Confused Response Flow</name>
      <description>
        Test processGoodbyeResponse with 'confused' type. Verify multi-step transition and side effects.
      </description>
      <steps>
        1. Verify goodbye_sent state
        2. Calculate days_since_goodbye
        3. Track analytics event
        4. Transition to help_flow (goodbye_response_1)
        5. Reset onboarding progress
        6. Queue help restart message
        7. Transition to active (user_message)
        8. Return localized confirmation
      </steps>
      <status>MOSTLY COVERED - Missing message queueing failure test</status>
    </scenario>
    <scenario id="4" priority="critical">
      <name>Busy Response Flow</name>
      <description>
        Test processGoodbyeResponse with 'busy' type. Verify single transition.
      </description>
      <steps>
        1. Verify goodbye_sent state
        2. Calculate days_since_goodbye
        3. Track analytics event
        4. Transition to remind_later (goodbye_response_2)
        5. Return localized confirmation
      </steps>
      <status>COVERED</status>
    </scenario>
    <scenario id="5" priority="critical">
      <name>All Good Response Flow</name>
      <description>
        Test processGoodbyeResponse with 'all_good' type. Verify single transition.
      </description>
      <steps>
        1. Verify goodbye_sent state
        2. Calculate days_since_goodbye
        3. Track analytics event
        4. Transition to dormant (goodbye_response_3)
        5. Return localized confirmation
      </steps>
      <status>COVERED</status>
    </scenario>
    <scenario id="6" priority="high">
      <name>Non-Goodbye Text from goodbye_sent State</name>
      <description>
        Test checkAndHandleGoodbyeResponse when user in goodbye_sent sends normal message.
        Must transition to active and return null.
      </description>
      <steps>
        1. User in goodbye_sent state
        2. Sends "gastei 50 no almoço"
        3. Transition to active with metadata
        4. Return null for normal processing
      </steps>
      <status>COVERED</status>
    </scenario>
    <scenario id="7" priority="high">
      <name>Goodbye-like Text from Non-goodbye_sent State</name>
      <description>
        Test checkAndHandleGoodbyeResponse when user NOT in goodbye_sent sends "1".
        Must return null without state change.
      </description>
      <steps>
        1. User in active state
        2. Sends "1"
        3. No state transition
        4. Return null for normal processing
      </steps>
      <status>PARTIAL - Not explicitly tested</status>
    </scenario>
    <scenario id="8" priority="high">
      <name>Message Queueing Failure (AC-7.4.9)</name>
      <description>
        Test confused response when getMessageDestination returns null.
        Handler must succeed with warning.
      </description>
      <steps>
        1. Mock getMessageDestination to return null
        2. Process confused response
        3. Onboarding reset succeeds
        4. State transitions succeed
        5. result.success=true
        6. Warning logged
      </steps>
      <status>NOT COVERED - GAP</status>
    </scenario>
    <scenario id="9" priority="medium">
      <name>State Transition Failure</name>
      <description>
        Test processGoodbyeResponse when transitionState fails.
        Must return error with preserved state.
      </description>
      <steps>
        1. Mock transitionState to fail
        2. Process goodbye response
        3. result.success=false
        4. result.error contains descriptive message
        5. Error logged
      </steps>
      <status>COVERED</status>
    </scenario>
    <scenario id="10" priority="medium">
      <name>Resilience: Active Transition Failure After Help Flow</name>
      <description>
        Test confused response when help_flow succeeds but active transition fails.
        Handler should continue with warning.
      </description>
      <steps>
        1. First transitionState (help_flow) succeeds
        2. Second transitionState (active) fails
        3. result.success=true (user got help message)
        4. Warning logged
      </steps>
      <status>NOT COVERED - GAP</status>
    </scenario>
    <scenario id="11" priority="medium">
      <name>Days Since Goodbye Calculation Edge Cases</name>
      <description>
        Test calculateDaysSinceGoodbye with edge cases.
      </description>
      <test-cases>
        - goodbye_sent_at = yesterday → days_since_goodbye=1
        - goodbye_sent_at = 7 days ago → days_since_goodbye=7
        - goodbye_sent_at = null → days_since_goodbye=0
        - DB error → days_since_goodbye=0, error logged
      </test-cases>
      <status>NOT COVERED - GAP</status>
    </scenario>
    <scenario id="12" priority="high">
      <name>Localization - Both Languages</name>
      <description>
        Test all confirmation messages in pt-BR and en.
      </description>
      <messages>
        confused: "Sem problemas..." / "No problem..."
        busy: "Entendido..." / "Got it..."
        all_good: "Tudo certo..." / "All good..."
        error: "Desculpa..." / "Sorry..."
      </messages>
      <status>COVERED</status>
    </scenario>
  </key-test-scenarios>

  <coverage-requirements>
    <metric>
      <name>Branches</name>
      <threshold>80%</threshold>
      <description>Conditional logic paths (if/else, switch, ternary)</description>
    </metric>
    <metric>
      <name>Functions</name>
      <threshold>80%</threshold>
      <description>All exported and helper functions</description>
    </metric>
    <metric>
      <name>Lines</name>
      <threshold>80%</threshold>
      <description>Executed lines of code</description>
    </metric>
    <metric>
      <name>Statements</name>
      <threshold>80%</threshold>
      <description>Individual statements executed</description>
    </metric>
    <execution-time>
      <max-duration>3 seconds</max-duration>
      <description>All tests must complete in under 3 seconds (unit test requirement)</description>
    </execution-time>
  </coverage-requirements>

  <related-documentation>
    <reference>
      <title>Story 7.4 - Goodbye Handler Tests</title>
      <path>docs/sprint-artifacts/7-4-goodbye-handler-tests.md</path>
    </reference>
    <reference>
      <title>Epic 7 Tech Spec - Testing &amp; Quality Assurance</title>
      <path>docs/sprint-artifacts/tech-spec-epic-7.md</path>
    </reference>
    <reference>
      <title>Story 7.1 - E2E Testing Framework Setup</title>
      <path>docs/sprint-artifacts/7-1-e2e-testing-framework-setup.md</path>
    </reference>
    <reference>
      <title>Story 4.4 - Goodbye Response Processing (Implementation)</title>
      <path>docs/sprint-artifacts/4-4-goodbye-response-processing.md</path>
    </reference>
    <reference>
      <title>Goodbye Handler Implementation</title>
      <path>whatsapp-bot/src/handlers/engagement/goodbye-handler.ts</path>
    </reference>
    <reference>
      <title>Existing Test Suite</title>
      <path>whatsapp-bot/src/__tests__/handlers/engagement/goodbye-handler.test.ts</path>
    </reference>
  </related-documentation>
</story-context>
