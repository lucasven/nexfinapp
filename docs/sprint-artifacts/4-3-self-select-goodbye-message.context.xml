<story-context id="4-3-self-select-goodbye-message" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>3</storyId>
    <title>Self-Select Goodbye Message</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-22</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-3-self-select-goodbye-message.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user who has been inactive</asA>
    <iWant>a respectful goodbye message with options</iWant>
    <soThat>I can choose how to proceed without pressure</soThat>
    <tasks>
      <task id="1" ac="1,2">Extend transitionState() for goodbye side effects - detect activeâ†’goodbye_sent, set timestamps</task>
      <task id="2" ac="1,5">Implement goodbye message queuing with idempotency key</task>
      <task id="3" ac="3">Resolve user destination for queuing via getMessageDestination()</task>
      <task id="4" ac="4">Add goodbye message localization keys to pt-br.ts and en.ts</task>
      <task id="5" ac="4">Fetch user locale for message params</task>
      <task id="6" ac="5">Prevent duplicate goodbye sending via idempotency</task>
      <task id="7" ac="1-5">Write unit tests</task>
      <task id="8" ac="1">Update services/engagement/index.ts exports</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="4.3.1">Transition to goodbye_sent state queues goodbye message via message queue service</ac>
    <ac id="4.3.2">On transition, goodbye_sent_at=now() and goodbye_expires_at=now()+48h are set in user_engagement_states</ac>
    <ac id="4.3.3">Message is routed to user's preferred destination (individual or group)</ac>
    <ac id="4.3.4">Message includes all 3 options (1, 2, 3) in user's locale (pt-BR or en)</ac>
    <ac id="4.3.5">Duplicate goodbye is prevented via idempotency key pattern</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-4.md" title="Epic 4 Technical Specification" section="Story 4.3: Self-Select Goodbye Message">
        AC4.3.1-5 defined with detailed criteria. Goodbye message queued on goodbye_sent transition, timestamps set, routed to preferred destination.
      </doc>
      <doc path="docs/architecture.md" title="Architecture" section="Novel Pattern Design: Engagement State Machine">
        5-state machine design. goodbye_sent state sets goodbye_sent_at, goodbye_expires_at. Valid transitions defined in VALID_TRANSITIONS map.
      </doc>
      <doc path="docs/architecture.md" title="Architecture" section="ADR-003: Message Queue Table">
        All proactive messages queued before sending. Idempotency keys prevent duplicates. Format: {userId}:{eventType}:{YYYY-MM-DD}
      </doc>
      <doc path="docs/epics.md" title="Epics" section="Story 4.3: Self-Select Goodbye Message">
        User story and acceptance criteria. Queues 3-option goodbye message on transition to goodbye_sent. Sets 48h timeout.
      </doc>
      <doc path="docs/prd.md" title="PRD" section="FR13, FR17">
        FR13: Send self-select goodbye message on state transition. FR17: 48h timeout to dormant. Tone: dignity, no guilt/pressure.
      </doc>
    </docs>

    <code>
      <file path="whatsapp-bot/src/services/engagement/state-machine.ts" kind="service" symbol="transitionState">
        <lines>49-65</lines>
        <reason>Core function to extend with goodbye side effects. Currently stub - needs full implementation for goodbye_sent transitions.</reason>
      </file>
      <file path="whatsapp-bot/src/services/engagement/types.ts" kind="types" symbol="EngagementState, TransitionTrigger, UserEngagementState">
        <lines>22-100</lines>
        <reason>Type definitions for state machine. UserEngagementState has goodbyeSentAt, goodbyeExpiresAt fields.</reason>
      </file>
      <file path="whatsapp-bot/src/services/engagement/constants.ts" kind="constants" symbol="GOODBYE_TIMEOUT_HOURS, MESSAGE_TYPE_PREFIXES">
        <lines>27, 109-116</lines>
        <reason>GOODBYE_TIMEOUT_HOURS=48 for expiry calculation. MESSAGE_TYPE_PREFIXES maps 'goodbye' to localization prefix.</reason>
      </file>
      <file path="whatsapp-bot/src/services/scheduler/message-sender.ts" kind="service" symbol="queueMessage, getIdempotencyKey">
        <lines>45-129</lines>
        <reason>queueMessage() for queuing goodbye. getIdempotencyKey() for generating unique keys. Already implemented with upsert/ignore duplicates.</reason>
      </file>
      <file path="whatsapp-bot/src/services/engagement/message-router.ts" kind="service" symbol="getMessageDestination">
        <lines>29-67</lines>
        <reason>getMessageDestination() returns destination type and JID. Use for routing goodbye to preferred destination.</reason>
      </file>
      <file path="whatsapp-bot/src/localization/pt-br.ts" kind="localization" symbol="messages">
        <lines>1-100</lines>
        <reason>Portuguese localization. Add engagement.goodbye_self_select key for goodbye message.</reason>
      </file>
      <file path="whatsapp-bot/src/localization/en.ts" kind="localization" symbol="messages">
        <reason>English localization. Add engagement.goodbye_self_select key for goodbye message.</reason>
      </file>
      <file path="whatsapp-bot/src/handlers/engagement/goodbye-handler.ts" kind="handler" symbol="goodbye-handler">
        <reason>Placeholder handler for processing goodbye responses (Story 4.4). Message format defined here must match.</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="^2.39.3">Database client for state updates</package>
        <package name="posthog-node" version="^5.11.2">Analytics events for state transitions</package>
      </node>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface name="transitionState" kind="function" path="whatsapp-bot/src/services/engagement/state-machine.ts">
      <signature>async function transitionState(options: TransitionOptions): Promise&lt;TransitionResult&gt;</signature>
      <note>Extend to add goodbye side effects when newState === 'goodbye_sent'</note>
    </interface>
    <interface name="queueMessage" kind="function" path="whatsapp-bot/src/services/scheduler/message-sender.ts">
      <signature>async function queueMessage(params: QueueMessageParams): Promise&lt;boolean&gt;</signature>
      <note>Already implemented with idempotency. Call from state machine for goodbye queuing.</note>
    </interface>
    <interface name="getIdempotencyKey" kind="function" path="whatsapp-bot/src/services/scheduler/message-sender.ts">
      <signature>function getIdempotencyKey(userId: string, eventType: string, date?: Date): string</signature>
      <note>Format: {userId}:{eventType}:{YYYY-MM-DD}. Use eventType='goodbye_sent'</note>
    </interface>
    <interface name="getMessageDestination" kind="function" path="whatsapp-bot/src/services/engagement/message-router.ts">
      <signature>async function getMessageDestination(userId: string): Promise&lt;RouteResult | null&gt;</signature>
      <note>Returns { destination, destinationJid }. Use for routing goodbye message.</note>
    </interface>
    <interface name="UserEngagementState" kind="type" path="whatsapp-bot/src/services/engagement/types.ts">
      <signature>interface UserEngagementState { goodbyeSentAt: Date | null; goodbyeExpiresAt: Date | null; ... }</signature>
      <note>Set both timestamps when transitioning to goodbye_sent state.</note>
    </interface>
  </interfaces>

  <constraints>
    <constraint source="Architecture">All state changes MUST go through transitionState() - never update DB directly</constraint>
    <constraint source="Architecture">Every transition logged to engagement_state_transitions table</constraint>
    <constraint source="Architecture">All proactive messages queued before sending (idempotency, retry capability)</constraint>
    <constraint source="PRD">Tone: curiosity, dignity, no guilt/pressure. Max 1 emoji per message.</constraint>
    <constraint source="Architecture">Idempotency key format: {userId}:{eventType}:{YYYY-MM-DD}</constraint>
    <constraint source="Epic 4 Tech Spec">48h timeout = goodbye_expires_at = now() + 48 hours</constraint>
    <constraint source="Architecture">Use Supabase service client for engagement operations</constraint>
  </constraints>

  <tests>
    <standards>
      Jest with ts-jest for TypeScript. Mocks in __mocks__/ directory. Coverage target 70%.
      Follow existing patterns from __tests__/engagement/activity-tracker.test.ts.
      Mock Supabase client for database operations.
    </standards>
    <locations>
      <location>whatsapp-bot/src/__tests__/engagement/*.test.ts</location>
      <location>whatsapp-bot/src/__tests__/handlers/engagement/*.test.ts</location>
    </locations>
    <ideas>
      <test ac="4.3.1">Transition to goodbye_sent calls queueMessage with correct params</test>
      <test ac="4.3.2">goodbye_sent_at and goodbye_expires_at timestamps set correctly (48h difference)</test>
      <test ac="4.3.2">48h expiry calculation is accurate across timezones</test>
      <test ac="4.3.3">Message routed to individual destination when preferred</test>
      <test ac="4.3.3">Message routed to group destination with correct JID</test>
      <test ac="4.3.4">Message uses correct localization key (engagement.goodbye_self_select)</test>
      <test ac="4.3.4">pt-BR user gets Portuguese message</test>
      <test ac="4.3.4">en user gets English message</test>
      <test ac="4.3.5">Duplicate goodbye same day is prevented (idempotency)</test>
      <test ac="4.3.5">Goodbye on different day creates new queue entry</test>
      <test ac="4.3.1">Side effects array includes 'set_goodbye_timestamps' and 'queued_goodbye_message'</test>
    </ideas>
  </tests>
</story-context>
