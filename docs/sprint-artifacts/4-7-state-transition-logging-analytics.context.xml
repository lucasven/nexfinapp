<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>7</storyId>
    <title>State Transition Logging &amp; Analytics</title>
    <status>drafted</status>
    <generatedAt>2025-11-22</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-7-state-transition-logging-analytics.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>product team</asA>
    <iWant>all engagement state transitions logged with full context and analytics events fired</iWant>
    <soThat>we can analyze engagement patterns, measure re-engagement effectiveness, and debug user journeys</soThat>
    <tasks>
      <task id="1" acs="1,3,4,5">Enhance transitionState() to capture full metadata
        <subtask>Calculate days_inactive from last_activity_at to now for all transitions</subtask>
        <subtask>Add response_type mapping for goodbye triggers (confused/busy/all_good/timeout)</subtask>
        <subtask>Calculate unprompted_return for user_message triggers from dormant state</subtask>
        <subtask>Ensure metadata object is properly typed with all optional fields</subtask>
      </task>
      <task id="2" acs="1,6">Create logTransition() helper function
        <subtask>Add function to services/engagement/state-machine.ts</subtask>
        <subtask>Insert into engagement_state_transitions table</subtask>
        <subtask>Handle database errors gracefully (log but don't fail transition)</subtask>
      </task>
      <task id="3" acs="2,7">Add PostHog event firing
        <subtask>Import trackEvent from existing analytics/tracker.ts</subtask>
        <subtask>Fire engagement_state_changed event on every successful transition</subtask>
        <subtask>Ensure event is non-blocking (fire and forget pattern)</subtask>
        <subtask>Handle PostHog client errors gracefully</subtask>
      </task>
      <task id="4" acs="3,4">Create specialized analytics events for key transitions
        <subtask>Fire engagement_goodbye_response event for goodbye-related transitions</subtask>
        <subtask>Fire engagement_unprompted_return event when user returns unprompted</subtask>
      </task>
      <task id="5" acs="1,3,4,5">Add metadata type definitions
        <subtask>Update services/engagement/types.ts with TransitionMetadata interface</subtask>
        <subtask>Ensure backward compatibility with existing code</subtask>
      </task>
      <task id="6" acs="4">Implement unprompted return detection logic
        <subtask>Check if user was in dormant state</subtask>
        <subtask>Check if now - last_activity_at >= 3 days</subtask>
        <subtask>Check if no goodbye message was sent (not from goodbye_sent)</subtask>
      </task>
      <task id="7" acs="5">Create helper to calculate days inactive
        <subtask>Add calculateDaysInactive utility function</subtask>
        <subtask>Handle edge cases (null last_activity_at, future dates)</subtask>
      </task>
      <task id="8" acs="1-7">Write unit tests for analytics logging
        <subtask>Test transition creates log entry</subtask>
        <subtask>Test PostHog event fired with correct properties</subtask>
        <subtask>Test days_inactive calculated correctly</subtask>
        <subtask>Test response_type mapped correctly</subtask>
        <subtask>Test unprompted_return set correctly</subtask>
        <subtask>Test database error doesn't fail the transition</subtask>
        <subtask>Test PostHog error doesn't fail the transition</subtask>
      </task>
      <task id="9" acs="6">Add query helpers for analytics
        <subtask>getUserTransitionHistory(userId, limit) function</subtask>
        <subtask>getTransitionStats(startDate, endDate) function</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-4.7.1">Every successful state transition creates a record in engagement_state_transitions with from_state, to_state, trigger, metadata, and created_at</criterion>
    <criterion id="AC-4.7.2">PostHog event engagement_state_changed is fired on every transition with properties: from_state, to_state, trigger, days_inactive</criterion>
    <criterion id="AC-4.7.3">Goodbye response type is tracked in transition metadata when applicable (response_type: 'confused' | 'busy' | 'all_good' | 'timeout') - FR40</criterion>
    <criterion id="AC-4.7.4">Unprompted return events are tracked in metadata (unprompted_return: true when user returns after 3+ days without re-engagement prompt) - FR41</criterion>
    <criterion id="AC-4.7.5">Days since last activity is included in all transition metadata (days_inactive field) - FR42</criterion>
    <criterion id="AC-4.7.6">All transition logs can be queried by user_id for debugging user journey reconstruction</criterion>
    <criterion id="AC-4.7.7">PostHog events include user's preferred destination for segmentation analytics</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Smart Onboarding &amp; Engagement System Architecture</title>
        <section>Analytics Events</section>
        <snippet>Analytics Events table defines: engagement_state_changed (from_state, to_state, trigger, days_inactive), engagement_goodbye_response (response_type: confused/busy/all_good/timeout). Dual-track approach: DB for historical queries, PostHog for real-time dashboards.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic Technical Specification: Engagement State Machine</title>
        <section>Story 4.7: State Transition Logging &amp; Analytics</section>
        <snippet>AC4.7.1-7 define transition logging, PostHog events, response_type tracking, unprompted_return detection, days_inactive calculation. Traceability maps each AC to transitionState() and PostHog client.</snippet>
      </doc>
      <doc>
        <path>docs/index.md</path>
        <title>NexFinApp Technical Documentation Index</title>
        <section>Architecture Overview</section>
        <snippet>PostHog integration for user events and funnels. WhatsApp bot analytics via analytics/ directory with tracker.ts and events.ts for event taxonomy.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>whatsapp-bot/src/services/engagement/state-machine.ts</path>
        <kind>service</kind>
        <symbol>transitionState</symbol>
        <lines>92-295</lines>
        <reason>PRIMARY FILE: Contains transitionState() function that must be enhanced to add analytics logging and PostHog event firing. Currently logs to engagement_state_transitions table but doesn't fire PostHog events. days_inactive already calculated at line 174-176.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/services/engagement/types.ts</path>
        <kind>types</kind>
        <symbol>EngagementState, TransitionTrigger, StateTransition</symbol>
        <lines>1-205</lines>
        <reason>Type definitions for state machine. StateTransition interface at line 72-80 has metadata: Record&lt;string, unknown&gt;. Need to add TransitionMetadata interface with typed fields for response_type, unprompted_return, days_inactive.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/analytics/tracker.ts</path>
        <kind>service</kind>
        <symbol>trackEvent</symbol>
        <lines>12-37</lines>
        <reason>EXISTING ANALYTICS: trackEvent(event, distinctId, properties) function for PostHog integration. Use this for firing engagement_state_changed events. Already handles null PostHog client and errors gracefully.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/analytics/events.ts</path>
        <kind>types</kind>
        <symbol>WhatsAppAnalyticsEvent</symbol>
        <lines>1-137</lines>
        <reason>Event taxonomy enum. Need to add: ENGAGEMENT_STATE_CHANGED, ENGAGEMENT_GOODBYE_RESPONSE, ENGAGEMENT_UNPROMPTED_RETURN to this enum. Follow existing naming convention (SCREAMING_SNAKE_CASE).</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/services/engagement/constants.ts</path>
        <kind>config</kind>
        <symbol>GOODBYE_TIMEOUT_HOURS, REMIND_LATER_DAYS</symbol>
        <lines>all</lines>
        <reason>Configuration constants. May need to add UNPROMPTED_RETURN_DAYS = 3 constant for the 3-day threshold.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/services/engagement/activity-tracker.ts</path>
        <kind>service</kind>
        <symbol>trackActivity</symbol>
        <lines>all</lines>
        <reason>Activity tracking service. May need to coordinate with for detecting unprompted return scenarios.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/__tests__/services/engagement/state-machine.test.ts</path>
        <kind>test</kind>
        <symbol>transitionState tests</symbol>
        <lines>1-829</lines>
        <reason>Existing test file for state machine. Add tests for: PostHog event firing, response_type mapping, unprompted_return detection, days_inactive calculation. Use mockQuerySequence pattern.</reason>
      </file>
      <file>
        <path>whatsapp-bot/src/__mocks__/supabase.ts</path>
        <kind>mock</kind>
        <symbol>mockSupabaseClient, mockQuerySequence</symbol>
        <lines>all</lines>
        <reason>Test mocks for Supabase. Use for mocking engagement_state_transitions inserts in tests.</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package name="posthog-node" version="^5.11.2">PostHog analytics client</package>
        <package name="@supabase/supabase-js" version="^2.39.3">Database client for transition logging</package>
        <package name="pino" version="^8.17.2">Structured logging</package>
        <package name="jest" version="^29.7.0" dev="true">Test framework</package>
        <package name="ts-jest" version="^29.1.1" dev="true">TypeScript Jest transformer</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture">Analytics logging should NEVER cause a state transition to fail: Wrap database log insert in try/catch, wrap PostHog calls in try/catch, log errors but continue execution. State integrity is more important than analytics.</constraint>
    <constraint source="architecture">All state changes MUST go through transitionState() - never update DB directly (Single Source of Truth)</constraint>
    <constraint source="architecture">Use snake_case for analytics events (engagement_state_changed) per naming convention</constraint>
    <constraint source="dev-notes">PostHog events are fire-and-forget, non-blocking</constraint>
    <constraint source="dev-notes">Dual-track approach: DB for queries (engagement_state_transitions table), PostHog for real-time dashboards</constraint>
    <constraint source="existing-code">transitionState() already calculates days_inactive (line 174-176) and logs to engagement_state_transitions (line 237-248). Enhance existing code rather than rewriting.</constraint>
    <constraint source="existing-code">Use existing trackEvent() from analytics/tracker.ts - already handles null PostHog and errors gracefully</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>transitionState</name>
      <kind>function</kind>
      <signature>async function transitionState(userId: string, trigger: TransitionTrigger, metadata?: Record&lt;string, unknown&gt;): Promise&lt;TransitionResult&gt;</signature>
      <path>whatsapp-bot/src/services/engagement/state-machine.ts</path>
    </interface>
    <interface>
      <name>trackEvent</name>
      <kind>function</kind>
      <signature>function trackEvent(event: WhatsAppAnalyticsEvent | string, distinctId: string, properties?: EventProperties): void</signature>
      <path>whatsapp-bot/src/analytics/tracker.ts</path>
    </interface>
    <interface>
      <name>TransitionMetadata (NEW)</name>
      <kind>interface</kind>
      <signature>interface TransitionMetadata { days_inactive: number; response_type?: 'confused' | 'busy' | 'all_good' | 'timeout'; unprompted_return?: boolean; days_since_goodbye?: number; hours_waited?: number; trigger_source?: 'user_message' | 'scheduler'; }</signature>
      <path>whatsapp-bot/src/services/engagement/types.ts</path>
    </interface>
    <interface>
      <name>getUserTransitionHistory (NEW)</name>
      <kind>function</kind>
      <signature>async function getUserTransitionHistory(userId: string, limit?: number): Promise&lt;StateTransitionLog[]&gt;</signature>
      <path>whatsapp-bot/src/services/engagement/state-machine.ts</path>
    </interface>
    <interface>
      <name>engagement_state_transitions</name>
      <kind>table</kind>
      <signature>CREATE TABLE engagement_state_transitions (id UUID PK, user_id UUID FK, from_state TEXT, to_state TEXT, trigger TEXT, metadata JSONB, created_at TIMESTAMPTZ); INDEX: idx_transitions_user(user_id), idx_transitions_created(created_at)</signature>
      <path>fe/scripts/034_engagement_system.sql</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Jest test framework with ts-jest for TypeScript support. Tests use mockQuerySequence() helper from __mocks__/supabase.ts to simulate database responses. Mock external services (PostHog, Supabase) for unit tests. Use jest.useFakeTimers() for time-dependent tests. Follow existing test patterns in state-machine.test.ts. Coverage threshold: 70% (branches, functions, lines, statements).</standards>
    <locations>
      <location>whatsapp-bot/src/__tests__/services/engagement/state-machine.test.ts</location>
      <location>whatsapp-bot/src/__tests__/services/engagement/analytics.test.ts (NEW)</location>
    </locations>
    <ideas>
      <testIdea ac="AC-4.7.1">Test that every successful transition via transitionState() inserts a record into engagement_state_transitions with correct from_state, to_state, trigger, metadata, created_at. Mock Supabase insert and verify parameters.</testIdea>
      <testIdea ac="AC-4.7.2">Test that trackEvent() is called with 'engagement_state_changed' event after each transition. Mock analytics/tracker and verify call arguments include from_state, to_state, trigger, days_inactive.</testIdea>
      <testIdea ac="AC-4.7.3">Test response_type mapping: goodbye_response_1->confused, goodbye_response_2->busy, goodbye_response_3->all_good, goodbye_timeout->timeout. Verify metadata includes correct response_type for each trigger.</testIdea>
      <testIdea ac="AC-4.7.4">Test unprompted_return detection: Create user in dormant state with last_activity 5 days ago, send user_message trigger, verify metadata.unprompted_return=true. Test negative case: user in goodbye_sent (not unprompted).</testIdea>
      <testIdea ac="AC-4.7.5">Test days_inactive calculation: User with last_activity 15 days ago, trigger transition, verify metadata.days_inactive=15. Test edge cases: 0 days, null last_activity_at.</testIdea>
      <testIdea ac="AC-4.7.6">Test getUserTransitionHistory(userId) returns ordered array of StateTransitionLog. Test with limit parameter. Verify indexed query performance.</testIdea>
      <testIdea ac="AC-4.7.7">Test PostHog event includes preferred_destination property. Mock user profile query to return destination preference.</testIdea>
      <testIdea ac="error-handling">Test that database error during transition logging does NOT fail the overall transition. State update should succeed, analytics failure logged.</testIdea>
      <testIdea ac="error-handling">Test that PostHog error does NOT fail the transition. Verify try/catch wraps trackEvent call.</testIdea>
    </ideas>
  </tests>
</story-context>
