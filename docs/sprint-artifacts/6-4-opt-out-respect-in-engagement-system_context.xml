<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>6.4</story-id>
    <story-key>6-4-opt-out-respect-in-engagement-system</story-key>
    <story-title>Opt-Out Respect in Engagement System</story-title>
    <epic>Epic 6: User Preferences & Web Integration</epic>
    <status>ready-for-dev</status>
    <generated-date>2025-11-24</generated-date>
  </metadata>

  <objective>
    Ensure the engagement system schedulers (daily engagement job, weekly review job) respect user opt-out preferences by filtering opted-out users BEFORE queuing re-engagement messages. This story is the enforcement point for user preferences set via WhatsApp (Story 6.1) or web (Story 6.2), ensuring 100% LGPD compliance.
  </objective>

  <key-requirements>
    <requirement id="AC-6.4.1">
      Daily engagement job MUST exclude users with reengagement_opt_out=true when evaluating 14-day inactive users for goodbye messages.
    </requirement>
    <requirement id="AC-6.4.2">
      Weekly review job MUST exclude users with reengagement_opt_out=true when evaluating active users for weekly review messages.
    </requirement>
    <requirement id="AC-6.4.3">
      Onboarding tips (tier completion) MUST still be sent to opted-out users (different preference from Story 3.5, NOT affected by reengagement_opt_out).
    </requirement>
    <requirement id="AC-6.4.4">
      Race condition is acceptable: If user opts out AFTER goodbye message is queued but BEFORE it's sent, the message sends once, but future messages are blocked.
    </requirement>
    <requirement id="AC-6.4.5">
      Scheduler query with opt-out filter MUST complete in &lt; 5 seconds for 10,000+ users (performance requirement).
    </requirement>
    <requirement id="AC-6.4.6">
      Scheduler logs MUST include count of users skipped due to opt-out for observability.
    </requirement>
  </key-requirements>

  <implementation-notes>
    <critical-pattern>
      The scheduler query filters are the ENFORCEMENT POINT for user preferences. The filter `.eq('user_profiles.reengagement_opt_out', false)` MUST be added to both daily and weekly scheduler queries BEFORE queuing messages. This is a LGPD compliance requirement and MUST work 100% reliably.
    </critical-pattern>

    <distinction type="CRITICAL">
      <preference name="reengagement_opt_out">
        <affects>Goodbye messages (14-day inactivity), Weekly review messages</affects>
        <does-not-affect>Onboarding tips (tier completion), Transaction-related tips, Explicit command responses</does-not-affect>
      </preference>
      <rationale>
        Re-engagement messages are push notifications to inactive users (user can opt out).
        Onboarding tips are contextual help after user actions (always helpful, no opt-out needed).
        LGPD compliance: User controls push notifications but still receives in-context help.
      </rationale>
    </distinction>

    <integration-flow>
      <step n="1">Daily Scheduler Runs (Epic 5)</step>
      <step n="2">Query Eligible Users with filters:
        - state = 'active'
        - last_activity_at &lt; 14 days
        - reengagement_opt_out = false (CRITICAL FILTER)</step>
      <step n="3">Opted-out users are SKIPPED silently</step>
      <step n="4">Non-opted-out users have goodbye messages queued</step>
      <step n="5">Log: "Users skipped due to opt-out: X" for observability</step>
    </integration-flow>
  </implementation-notes>

  <existing-code-context>
    <file path="whatsapp-bot/src/services/scheduler/daily-engagement-job.ts">
      <summary>
        Daily engagement job that runs once daily to process 14-day inactive users.
        Currently queries user_engagement_states for users with state='active' and last_activity_at &lt; 14 days ago.
        ALREADY implements opt-out filtering (AC-5.1.4 from Epic 5):
        - Queries user_profiles.reengagement_opt_out for inactive users
        - Skips users where reengagement_opt_out=true
        - Tracks skipped count in result.skipped
        - Logs skipped users with logger.debug
      </summary>
      <key-functions>
        <function name="runDailyEngagementJob">
          Main job entry point. Processes inactive users, goodbye timeouts, and remind_later states.
          Returns JobResult with processed/succeeded/failed/skipped counts.
        </function>
        <function name="processInactiveUsers">
          Handles AC-6.4.1 and AC-6.4.6.
          ALREADY IMPLEMENTED: Queries user_profiles for opt-out status, builds optOutMap, skips opted-out users.
          Increments result.skipped for each opted-out user.
        </function>
      </key-functions>
      <current-implementation>
        Lines 115-147: Queries inactive users, then queries user_profiles for opt-out status
        Lines 155-162: Checks optOutMap, skips if isOptedOut===true, increments result.skipped
        LOGGING: logger.debug on line 160 logs each skipped user
        ISSUE: Missing aggregate log for total skipped count (AC-6.4.6 requires visible logging)
      </current-implementation>
      <modification-needed>
        Add logger.info in processInactiveUsers AFTER loop completes:
        logger.info('Inactive users processed', { total: inactiveUsers.length, skipped: result.skipped })
        This satisfies AC-6.4.6 (observability logging).
      </modification-needed>
    </file>

    <file path="whatsapp-bot/src/services/scheduler/weekly-review-job.ts">
      <summary>
        Weekly review job that runs once weekly (Monday 9 AM UTC) to send celebratory messages to active users.
        Uses getActiveUsersLastWeek() from activity-detector.ts to get eligible users.
        Does NOT currently filter by reengagement_opt_out (needs implementation for AC-6.4.2).
      </summary>
      <key-functions>
        <function name="runWeeklyReviewJob">
          Main job entry point. Gets active users, queues weekly_review messages, processes queue.
          Returns JobResult with processed/succeeded/failed/skipped counts.
        </function>
      </key-functions>
      <current-implementation>
        Line 56: Calls getActiveUsersLastWeek() to get eligible users
        Lines 63-132: Loops through activeUsers and queues weekly_review messages
        NO OPT-OUT FILTERING: All users returned by getActiveUsersLastWeek() are queued
      </current-implementation>
      <modification-needed>
        The opt-out filter is ALREADY IMPLEMENTED in the database function get_active_users_last_week().
        See activity-detector.ts line 64: supabase.rpc('get_active_users_last_week')
        Verify that the RPC function filters reengagement_opt_out=false in SQL.
        If not, add .eq('user_profiles.reengagement_opt_out', false) filter to the RPC query.
      </modification-needed>
    </file>

    <file path="whatsapp-bot/src/services/scheduler/activity-detector.ts">
      <summary>
        Activity detection service for weekly review. Calls database function get_active_users_last_week()
        which returns users with activity in the last 7 days.
        AC-5.2.3 states: "Excludes opted-out users (reengagement_opt_out = true)".
        Relies on database RPC function to apply opt-out filter (AC-6.4.2).
      </summary>
      <key-functions>
        <function name="getActiveUsersLastWeek">
          Calls supabase.rpc('get_active_users_last_week') to get users with transactions OR bot activity in last 7 days.
          Expected to return users WHERE reengagement_opt_out = false (per AC-5.2.3).
        </function>
      </key-functions>
      <current-implementation>
        Line 64: supabase.rpc('get_active_users_last_week', { since_date })
        The RPC function is expected to handle opt-out filtering in SQL.
        No TypeScript-level filtering needed (database handles it).
      </current-implementation>
      <verification-needed>
        Ensure the SQL function get_active_users_last_week includes:
        WHERE user_profiles.reengagement_opt_out = false
        This satisfies AC-6.4.2 for weekly review job.
      </verification-needed>
    </file>

    <file path="whatsapp-bot/src/handlers/engagement/opt-out-handler.ts">
      <summary>
        Handles user opt-out/opt-in commands for both onboarding tips AND re-engagement messages.
        Re-engagement opt-out implemented in handleOptOutCommand() (Epic 6).
        Updates user_profiles.reengagement_opt_out column.
      </summary>
      <key-functions>
        <function name="handleOptOutCommand">
          AC-6.1.1: Updates reengagement_opt_out to true for opt-out
          AC-6.1.2: Updates reengagement_opt_out to false for opt-in
          Tracks PostHog event: engagement_preference_changed
        </function>
        <function name="parseOptOutCommand">
          AC-6.1.3: Generous pattern matching for opt-out/opt-in intents
          Supports both pt-BR and English variations
        </function>
      </key-functions>
      <relevance>
        This handler sets the preference that Story 6.4 enforces.
        Story 6.4 does NOT modify this handler (it only modifies schedulers).
        Included for context: Shows how reengagement_opt_out is set by users.
      </relevance>
    </file>

    <file path="whatsapp-bot/src/services/engagement/constants.ts">
      <summary>Expected to contain INACTIVITY_THRESHOLD_DAYS = 14</summary>
      <usage>Used by daily-engagement-job.ts to calculate 14-day cutoff for inactive users</usage>
    </file>
  </existing-code-context>

  <database-context>
    <table name="user_profiles">
      <column name="reengagement_opt_out" type="boolean" default="false">
        Preference for re-engagement messages (goodbye, weekly review).
        Added in Epic 1, Story 1.1.
        Set by opt-out-handler.ts (Story 6.1) or web settings (Story 6.2).
        Read by schedulers (Story 6.4 - THIS STORY).
      </column>
      <column name="onboarding_tips_enabled" type="boolean" default="true">
        DIFFERENT preference for onboarding tips (tier completion).
        Story 3.5 implementation.
        AC-6.4.3: This preference does NOT affect tier tips (tips always send).
      </column>
    </table>

    <table name="user_engagement_states">
      <columns>user_id, state, last_activity_at, goodbye_sent_at, goodbye_expires_at, remind_at</columns>
      <usage>
        Queried by daily-engagement-job.ts to find inactive users (state='active', last_activity_at &lt; 14 days).
        Must be joined with user_profiles to filter by reengagement_opt_out.
      </usage>
    </table>

    <rpc-function name="get_active_users_last_week">
      <parameters>since_date (ISO timestamp)</parameters>
      <returns>user_id, transaction_count, last_activity_at, preferred_destination, destination_jid, locale</returns>
      <expected-filter>WHERE user_profiles.reengagement_opt_out = false</expected-filter>
      <usage>Called by getActiveUsersLastWeek() in activity-detector.ts (line 64)</usage>
      <verification>
        Ensure SQL function includes opt-out filter to satisfy AC-6.4.2.
        If missing, this is the PRIMARY modification needed for weekly review job.
      </verification>
    </rpc-function>

    <index-requirement>
      For performance with 10k+ users (AC-6.4.5):
      CREATE INDEX IF NOT EXISTS idx_reengagement_opt_out ON user_profiles(reengagement_opt_out);
      Verify with EXPLAIN ANALYZE on scheduler queries (target: &lt; 5s).
    </index-requirement>
  </database-context>

  <acceptance-criteria>
    <ac id="AC-6.4.1" priority="CRITICAL">
      <given>User has reengagement_opt_out = true</given>
      <when>Daily engagement job evaluates users for goodbye messages (14-day inactivity)</when>
      <then>User is EXCLUDED from results and no goodbye message is queued</then>
      <test-strategy>
        Unit test: Create user with opt-out=true + 14 days inactive → run job → assert NOT in goodbye queue
        Integration test: Verify opted-out user receives no messages over 30-day period
      </test-strategy>
      <implementation-status>ALREADY IMPLEMENTED in daily-engagement-job.ts (lines 155-162)</implementation-status>
      <verification-needed>Add test to confirm behavior, enhance logging (AC-6.4.6)</verification-needed>
    </ac>

    <ac id="AC-6.4.2" priority="CRITICAL">
      <given>User has reengagement_opt_out = true</given>
      <when>Weekly review job evaluates users for review messages</when>
      <then>User is EXCLUDED from results and no weekly review message is queued</then>
      <test-strategy>
        Unit test: Create user with opt-out=true + had activity → run job → assert NOT in review queue
        Integration test: Verify opted-out user with activity receives no weekly review
      </test-strategy>
      <implementation-status>EXPECTED in SQL function get_active_users_last_week</implementation-status>
      <verification-needed>Verify SQL function includes reengagement_opt_out=false filter</verification-needed>
    </ac>

    <ac id="AC-6.4.3" priority="HIGH">
      <given>User has reengagement_opt_out = true</given>
      <when>User completes a tier action (Tier 1, 2, or 3)</when>
      <then>Onboarding tips are STILL sent (different preference from Story 3.5)</then>
      <test-strategy>
        Unit test: User with opt-out=true completes Tier 1 → assert tier tip sent
        Verify tier completion handler does NOT check reengagement_opt_out
      </test-strategy>
      <implementation-status>No code changes needed (tier handler should NOT check reengagement_opt_out)</implementation-status>
      <verification-needed>Confirm tier completion code has no opt-out check, add test, document distinction</verification-needed>
    </ac>

    <ac id="AC-6.4.4" priority="LOW">
      <given>User opts out AFTER goodbye message is queued but BEFORE it's sent</given>
      <when>Message queue processor runs</when>
      <then>Queued message sends (acceptable race condition), but future messages are blocked</then>
      <test-strategy>
        Integration test: Queue goodbye → user opts out → process queue → assert message sent
        Verify next scheduler run excludes that user (opt-out respected going forward)
      </test-strategy>
      <implementation-status>Expected behavior (eventual consistency), no code changes</implementation-status>
      <verification-needed>Document in code comments, add test to confirm race condition behavior</verification-needed>
    </ac>

    <ac id="AC-6.4.5" priority="MEDIUM">
      <given>Scheduler runs with 10,000+ users in database</given>
      <when>Filtering by reengagement_opt_out = false</when>
      <then>Query completes in &lt; 5 seconds with no performance degradation</then>
      <test-strategy>
        Performance test: Seed database with 10k users (50% opted-out)
        Run scheduler jobs, measure query time with EXPLAIN ANALYZE
        Verify index on reengagement_opt_out is used
      </test-strategy>
      <implementation-status>Requires database index verification</implementation-status>
      <verification-needed>Check if idx_reengagement_opt_out exists, create if needed, run performance test</verification-needed>
    </ac>

    <ac id="AC-6.4.6" priority="MEDIUM">
      <given>User is opted out</given>
      <when>Daily scheduler logs its execution</when>
      <then>Log includes count of users skipped due to opt-out (for observability)</then>
      <test-strategy>
        Integration test: Create 3 opted-out + 2 opted-in users → run job → assert log shows "skipped: 3"
        Verify log format: { skipped_opted_out: number, total_eligible: number, queued: number }
      </test-strategy>
      <implementation-status>Partial (result.skipped tracked, but no aggregate log)</implementation-status>
      <verification-needed>Add logger.info in processInactiveUsers with skipped count</verification-needed>
    </ac>
  </acceptance-criteria>

  <tasks-breakdown>
    <task id="Task-1" status="todo" priority="HIGH">
      <title>Verify and enhance daily engagement job opt-out logging</title>
      <description>
        Daily job ALREADY filters opted-out users (AC-5.1.4 from Epic 5).
        Verify implementation correctness and enhance logging for AC-6.4.6.
      </description>
      <steps>
        <step>Review processInactiveUsers() in daily-engagement-job.ts (lines 109-192)</step>
        <step>Confirm opt-out filter works correctly (lines 155-162)</step>
        <step>Add logger.info after loop: { total_inactive: N, skipped_opted_out: result.skipped }</step>
        <step>Verify logging appears in daily job output</step>
      </steps>
      <files>whatsapp-bot/src/services/scheduler/daily-engagement-job.ts</files>
      <acceptance-criteria>AC-6.4.1, AC-6.4.6</acceptance-criteria>
    </task>

    <task id="Task-2" status="todo" priority="CRITICAL">
      <title>Verify weekly review job respects opt-out via SQL function</title>
      <description>
        Weekly job relies on get_active_users_last_week() SQL function to filter opted-out users.
        Verify SQL function includes reengagement_opt_out=false filter (AC-6.4.2).
      </description>
      <steps>
        <step>Locate SQL migration that defines get_active_users_last_week() function</step>
        <step>Verify function SQL includes: WHERE user_profiles.reengagement_opt_out = false</step>
        <step>If missing, update SQL function to add opt-out filter</step>
        <step>Test: User with opt-out=true + activity → NOT returned by function</step>
        <step>Add logging in runWeeklyReviewJob: { total_active: N, includes_opt_out_filter: true }</step>
      </steps>
      <files>fe/scripts/*.sql (migration defining RPC), whatsapp-bot/src/services/scheduler/activity-detector.ts</files>
      <acceptance-criteria>AC-6.4.2, AC-6.4.6</acceptance-criteria>
    </task>

    <task id="Task-3" status="todo" priority="HIGH">
      <title>Verify tier completion handler does NOT check opt-out</title>
      <description>
        Onboarding tips (tier completion) should ALWAYS send, regardless of reengagement_opt_out.
        Verify tier handler code does NOT check reengagement_opt_out (AC-6.4.3).
      </description>
      <steps>
        <step>Locate tier completion handler (handlers/onboarding/tier-completion.ts or similar)</step>
        <step>Search for "reengagement_opt_out" in handler code</step>
        <step>Confirm NO opt-out check exists (tips should always send)</step>
        <step>Add code comment documenting distinction from re-engagement messages</step>
        <step>Reference Story 3.5 (tier tips) and Story 6.4 (opt-out distinction)</step>
      </steps>
      <files>whatsapp-bot/src/handlers/onboarding/* (find tier completion handler)</files>
      <acceptance-criteria>AC-6.4.3</acceptance-criteria>
    </task>

    <task id="Task-4" status="todo" priority="LOW">
      <title>Document race condition as acceptable behavior</title>
      <description>
        If user opts out AFTER message is queued but BEFORE it's sent, message sends once.
        This is acceptable (eventual consistency). Document in code and tests (AC-6.4.4).
      </description>
      <steps>
        <step>Add code comment in message queue processor explaining race condition</step>
        <step>Document: "User opts out after queue but before send → message sends (acceptable)"</step>
        <step>Document: "Future messages blocked via scheduler filter"</step>
        <step>No code changes needed (expected behavior)</step>
      </steps>
      <files>whatsapp-bot/src/services/scheduler/message-sender.ts</files>
      <acceptance-criteria>AC-6.4.4</acceptance-criteria>
    </task>

    <task id="Task-5" status="todo" priority="MEDIUM">
      <title>Verify database index for opt-out filter performance</title>
      <description>
        Ensure database has index on user_profiles.reengagement_opt_out for query performance (AC-6.4.5).
      </description>
      <steps>
        <step>Check if index exists: SELECT * FROM pg_indexes WHERE tablename='user_profiles' AND indexname LIKE '%opt_out%'</step>
        <step>If missing, create: CREATE INDEX idx_reengagement_opt_out ON user_profiles(reengagement_opt_out)</step>
        <step>Run EXPLAIN ANALYZE on daily job query: SELECT * FROM user_engagement_states JOIN user_profiles WHERE reengagement_opt_out=false</step>
        <step>Verify query plan uses index scan</step>
        <step>Document expected performance: &lt; 5s for 10k users</step>
      </steps>
      <files>fe/scripts/029_add_opt_out_index.sql (new migration if needed)</files>
      <acceptance-criteria>AC-6.4.5</acceptance-criteria>
    </task>

    <task id="Task-6" status="todo" priority="MEDIUM">
      <title>Add observability logging to both scheduler jobs</title>
      <description>
        Both daily and weekly jobs should log counts of users skipped due to opt-out (AC-6.4.6).
      </description>
      <steps>
        <step>Daily job: Add logger.info with { total_eligible, skipped_opted_out, queued } after processInactiveUsers()</step>
        <step>Weekly job: Add logger.info with { total_active, skipped_opted_out, queued } after getActiveUsersLastWeek()</step>
        <step>Format: { skipped_opted_out: number, total_eligible: number, queued: number }</step>
        <step>Verify logs appear in Railway scheduler execution logs</step>
      </steps>
      <files>whatsapp-bot/src/services/scheduler/daily-engagement-job.ts, weekly-review-job.ts</files>
      <acceptance-criteria>AC-6.4.6</acceptance-criteria>
    </task>

    <task id="Task-7" status="todo" priority="HIGH">
      <title>Write unit tests for scheduler opt-out filter</title>
      <description>
        Test that both schedulers correctly filter opted-out users (AC-6.4.1, AC-6.4.2, AC-6.4.3).
      </description>
      <steps>
        <step>Test: User with opt-out=true + 14 days inactive → NO goodbye queued (AC-6.4.1)</step>
        <step>Test: User with opt-out=false + 14 days inactive → goodbye queued</step>
        <step>Test: User with opt-out=true + had activity → NO weekly review queued (AC-6.4.2)</step>
        <step>Test: User with opt-out=false + had activity → weekly review queued</step>
        <step>Test: User with opt-out=true + completes tier → tip sent (AC-6.4.3)</step>
        <step>Test: Multiple users (50% opt-out) → correct filtering in both jobs</step>
      </steps>
      <files>whatsapp-bot/src/__tests__/services/scheduler-optout.test.ts (new)</files>
      <acceptance-criteria>AC-6.4.1, AC-6.4.2, AC-6.4.3</acceptance-criteria>
    </task>

    <task id="Task-8" status="todo" priority="MEDIUM">
      <title>Write integration test for cross-scheduler verification</title>
      <description>
        End-to-end test that opted-out user receives no messages across 30-day period (AC-6.4.1, AC-6.4.2, AC-6.4.4).
      </description>
      <steps>
        <step>Test: Opted-out user receives no messages across 30-day period (both jobs respect opt-out)</step>
        <step>Test: Opted-out user opts back in → immediately eligible for messages</step>
        <step>Test: Race condition scenario (opt-out after queue, before send) → message sends once</step>
        <step>Test: 10k users with 50% opt-out rate → scheduler completes in &lt; 5s (AC-6.4.5)</step>
      </steps>
      <files>whatsapp-bot/src/__tests__/integration/scheduler-respect-optout.test.ts (new)</files>
      <acceptance-criteria>AC-6.4.1, AC-6.4.2, AC-6.4.4, AC-6.4.5</acceptance-criteria>
    </task>

    <task id="Task-9" status="todo" priority="LOW">
      <title>Update scheduler documentation</title>
      <description>
        Document opt-out filter in scheduler code comments and README (AC-6.4.6).
      </description>
      <steps>
        <step>Add comment in daily-engagement-job.ts explaining opt-out filter (AC-6.4.1)</step>
        <step>Add comment in weekly-review-job.ts explaining opt-out filter (AC-6.4.2)</step>
        <step>Reference Story 6.1 (opt-out command implementation)</step>
        <step>Document distinction: re-engagement vs onboarding tips (AC-6.4.3)</step>
        <step>If services/scheduler/README.md exists, update with opt-out filter documentation</step>
      </steps>
      <files>whatsapp-bot/src/services/scheduler/*.ts, services/scheduler/README.md (if exists)</files>
      <acceptance-criteria>AC-6.4.6</acceptance-criteria>
    </task>
  </tasks-breakdown>

  <testing-strategy>
    <unit-tests>
      <test file="whatsapp-bot/src/__tests__/services/scheduler-optout.test.ts">
        <test-case id="daily-job-opt-out-excluded">
          Given: User with reengagement_opt_out=true + 14 days inactive
          When: runDailyEngagementJob() is called
          Then: User is NOT in goodbye message queue, result.skipped incremented
        </test-case>
        <test-case id="daily-job-opt-in-included">
          Given: User with reengagement_opt_out=false + 14 days inactive
          When: runDailyEngagementJob() is called
          Then: User IS in goodbye message queue, result.succeeded incremented
        </test-case>
        <test-case id="weekly-job-opt-out-excluded">
          Given: User with reengagement_opt_out=true + had activity last week
          When: runWeeklyReviewJob() is called
          Then: User is NOT in weekly review queue
        </test-case>
        <test-case id="weekly-job-opt-in-included">
          Given: User with reengagement_opt_out=false + had activity last week
          When: runWeeklyReviewJob() is called
          Then: User IS in weekly review queue
        </test-case>
        <test-case id="tier-completion-ignores-opt-out">
          Given: User with reengagement_opt_out=true + completes Tier 1
          When: Tier completion handler is triggered
          Then: Tier tip is sent (opt-out does NOT block onboarding tips)
        </test-case>
        <test-case id="multiple-users-mixed-opt-out">
          Given: 10 users (5 opted-out, 5 opted-in), all 14 days inactive
          When: runDailyEngagementJob() is called
          Then: 5 users queued, 5 users skipped, result.skipped=5
        </test-case>
      </test>
    </unit-tests>

    <integration-tests>
      <test file="whatsapp-bot/src/__tests__/integration/scheduler-respect-optout.test.ts">
        <test-case id="30-day-no-messages">
          Given: User with reengagement_opt_out=true + 30 days inactive
          When: Daily and weekly jobs run over 30-day period
          Then: User receives ZERO goodbye or weekly review messages
        </test-case>
        <test-case id="opt-in-after-opt-out">
          Given: User opted out, then opts back in
          When: Next scheduler run evaluates user
          Then: User is immediately eligible for messages (opt-in respected)
        </test-case>
        <test-case id="race-condition-acceptable">
          Given: Goodbye message queued, then user opts out before send
          When: Message queue processor runs
          Then: Message sends once (acceptable), next scheduler run skips user
        </test-case>
        <test-case id="performance-10k-users">
          Given: Database with 10,000 users (50% opted-out)
          When: Daily or weekly job query runs with opt-out filter
          Then: Query completes in &lt; 5 seconds (AC-6.4.5)
        </test-case>
      </test>
    </integration-tests>

    <manual-qa>
      <checklist>
        <item>Set user to opted-out + 14 days inactive → Run daily job → No goodbye queued</item>
        <item>Set user to opted-in + 14 days inactive → Run daily job → Goodbye queued</item>
        <item>Check logs: "Users skipped due to opt-out: X" appears in daily job logs</item>
        <item>Set user to opted-out + complete Tier 1 → Tier tip sent (not blocked)</item>
        <item>Database: Verify no opted-out users in message_queue table after scheduler runs</item>
        <item>Performance: Run daily job with 10k users → completes in &lt; 5s</item>
      </checklist>
    </manual-qa>
  </testing-strategy>

  <dependencies>
    <dependency type="epic" status="completed">
      <name>Epic 1: Foundation &amp; Message Infrastructure</name>
      <reason>Provides user_profiles.reengagement_opt_out column (Story 1.1)</reason>
    </dependency>
    <dependency type="epic" status="completed">
      <name>Epic 5: Scheduled Jobs &amp; Weekly Reviews</name>
      <reason>Provides daily-engagement-job.ts and weekly-review-job.ts that Story 6.4 modifies</reason>
    </dependency>
    <dependency type="story" status="completed">
      <name>Story 6.1: WhatsApp Opt-Out Commands</name>
      <reason>Implements handleOptOutCommand() that sets reengagement_opt_out preference</reason>
    </dependency>
    <dependency type="story" status="completed">
      <name>Story 6.2: Web Settings Opt-Out Toggle</name>
      <reason>Provides web UI to set reengagement_opt_out preference</reason>
    </dependency>
    <dependency type="story" status="completed">
      <name>Story 3.5: Tier Completion Tips</name>
      <reason>Defines onboarding_tips_enabled preference (different from reengagement_opt_out)</reason>
    </dependency>
  </dependencies>

  <risks-and-mitigations>
    <risk id="risk-1" severity="CRITICAL" probability="VERY LOW">
      <description>Scheduler fails to respect opt-out (code bug) → All users receive messages</description>
      <impact>LGPD violation, user trust broken, potential legal issues</impact>
      <mitigation>
        Comprehensive test coverage (AC-6.4.1, AC-6.4.2).
        Alert if opted-out user receives message (monitoring).
        Code review to verify filter is applied in both jobs.
      </mitigation>
    </risk>

    <risk id="risk-2" severity="LOW" probability="MEDIUM">
      <description>Race condition: User opts out after message queued but before sent</description>
      <impact>User receives ONE message after opt-out (not a pattern)</impact>
      <mitigation>
        Acceptable behavior (eventual consistency).
        Document as expected in code and tests (AC-6.4.4).
        Future messages blocked via scheduler filter.
      </mitigation>
    </risk>

    <risk id="risk-3" severity="MEDIUM" probability="LOW">
      <description>Performance degradation with opt-out filter on 10k+ users</description>
      <impact>Scheduler takes >5s to run, delays message delivery</impact>
      <mitigation>
        Create database index on reengagement_opt_out (AC-6.4.5).
        Run EXPLAIN ANALYZE to verify query plan uses index.
        Performance test with 10k users before production deployment.
      </mitigation>
    </risk>

    <risk id="risk-4" severity="MEDIUM" probability="LOW">
      <description>SQL function get_active_users_last_week missing opt-out filter</description>
      <impact>Weekly review job sends messages to opted-out users (AC-6.4.2 violation)</impact>
      <mitigation>
        Verify SQL function includes reengagement_opt_out=false filter (Task 2).
        If missing, update SQL function in database migration.
        Integration test to confirm opted-out users excluded from weekly review.
      </mitigation>
    </risk>
  </risks-and-mitigations>

  <performance-requirements>
    <requirement id="perf-1">
      <metric>Scheduler query time with opt-out filter</metric>
      <target>&lt; 5 seconds for 10,000 users</target>
      <measurement>EXPLAIN ANALYZE on daily/weekly job queries</measurement>
      <implementation>Index on user_profiles.reengagement_opt_out</implementation>
    </requirement>

    <requirement id="perf-2">
      <metric>Memory usage during scheduler execution</metric>
      <target>No significant increase (&lt; 10% more than Epic 5 baseline)</target>
      <measurement>Railway monitoring dashboard</measurement>
      <implementation>Boolean filter adds negligible overhead</implementation>
    </requirement>
  </performance-requirements>

  <security-compliance>
    <lgpd-article-18>
      <requirement>Right to opt-out of push notifications</requirement>
      <implementation>reengagement_opt_out column allows users to control re-engagement messages</implementation>
      <enforcement>Story 6.4 schedulers filter opted-out users BEFORE queuing messages (100% compliance)</enforcement>
    </lgpd-article-18>

    <data-minimization>
      <requirement>Log only necessary user data</requirement>
      <implementation>Logs include user_id and counts only (no PII beyond what's necessary)</implementation>
    </data-minimization>
  </security-compliance>

  <references>
    <reference type="tech-spec">
      <file>docs/sprint-artifacts/tech-spec-epic-6.md</file>
      <sections>AC-6.4, Scheduler Integration Points, Scheduler Respects Opt-Out</sections>
    </reference>
    <reference type="story">
      <file>docs/sprint-artifacts/6-1-whatsapp-opt-out-opt-in-commands.md</file>
      <sections>Integration with Epic 5 Scheduler</sections>
    </reference>
    <reference type="epic-spec">
      <file>docs/sprint-artifacts/tech-spec-epic-5.md</file>
      <sections>Daily Engagement Job, Weekly Review Job</sections>
    </reference>
    <reference type="architecture">
      <file>docs/architecture.md</file>
      <sections>Engagement State Machine, Scheduler Architecture</sections>
    </reference>
  </references>
</story-context>
