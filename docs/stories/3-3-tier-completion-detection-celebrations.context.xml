<?xml version="1.0" encoding="UTF-8"?>
<story-context story-key="3-3-tier-completion-detection-celebrations" generated="2025-11-22">
  <story>
    <title>Tier Completion Detection and Celebrations</title>
    <epic>3 - Progressive Tier Journey</epic>
    <objective>Send celebration messages when users complete onboarding tiers</objective>
  </story>

  <acceptance-criteria>
    <criterion id="AC-3.3.1">Completing last Tier 1 action sends celebration with Tier 2 guidance</criterion>
    <criterion id="AC-3.3.2">Completing last Tier 2 action sends celebration with Tier 3 guidance</criterion>
    <criterion id="AC-3.3.3">Completing last Tier 3 action sends final "pro" celebration</criterion>
    <criterion id="AC-3.3.4">Celebration messages use max one emoji</criterion>
    <criterion id="AC-3.3.5">If tips disabled, NO celebration sent but progress tracked silently</criterion>
    <criterion id="AC-3.3.6">Messages queued via message queue service (idempotent)</criterion>
  </acceptance-criteria>

  <artifacts>
    <docs>
      <doc path="docs/stories/tech-spec-epic-3.md" relevance="high">Celebration flow and message content</doc>
      <doc path="docs/prd.md" relevance="medium">Tier unlock message copy and tone guidelines</doc>
    </docs>

    <code>
      <file path="whatsapp-bot/src/handlers/engagement/tier-progress-handler.ts" relevance="high">
        <purpose>Target file - implement handleTierCompletion</purpose>
        <current-state>Stub from Epic 1</current-state>
      </file>

      <file path="whatsapp-bot/src/services/onboarding/tier-tracker.ts" relevance="high">
        <purpose>Returns tierCompleted and shouldSendUnlock from recordAction</purpose>
      </file>

      <file path="whatsapp-bot/src/services/scheduler/message-sender.ts" relevance="high">
        <purpose>queueMessage function for idempotent message queuing</purpose>
      </file>

      <file path="whatsapp-bot/src/localization/pt-br.ts" relevance="high">
        <purpose>Tier celebration messages</purpose>
        <keys>engagementTier1Complete, engagementTier2Complete, engagementTier3Complete</keys>
      </file>

      <file path="whatsapp-bot/src/localization/en.ts" relevance="high">
        <purpose>English tier celebration messages</purpose>
      </file>
    </code>

    <dependencies>
      <dependency>services/onboarding/tier-tracker.ts - areTipsEnabled check</dependency>
      <dependency>services/scheduler/message-sender.ts - queueMessage, getIdempotencyKey</dependency>
      <dependency>localization/*.ts - celebration messages</dependency>
    </dependencies>
  </artifacts>

  <interfaces>
    <function name="handleTierCompletion" location="tier-progress-handler.ts">
      <param name="userId" type="string">User ID</param>
      <param name="tierUpdate" type="TierUpdate">Result from recordAction</param>
      <param name="locale" type="'pt-br' | 'en'">User's preferred language</param>
      <returns>void - Fire and forget</returns>
    </function>
  </interfaces>

  <localization-keys>
    <key name="engagementTier1Complete" language="pt-BR">
      Você já dominou o básico! Quer ir além? Tenta definir um orçamento: 'definir orçamento de 500 para alimentação'
    </key>
    <key name="engagementTier2Complete" language="pt-BR">
      Você não está só rastreando—está planejando! Pronto pra ver o panorama geral? Tenta 'ver relatório'
    </key>
    <key name="engagementTier3Complete" language="pt-BR">
      Você é um profissional agora! Você tem controle total das suas finanças.
    </key>
  </localization-keys>

  <constraints>
    <constraint type="tone">Max one emoji per message</constraint>
    <constraint type="tone">Celebratory but not over-the-top</constraint>
    <constraint type="idempotent">Use idempotency key: {userId}:tier_{n}_complete:{date}</constraint>
    <constraint type="pattern">Check areTipsEnabled before queuing</constraint>
  </constraints>

  <tests>
    <test-file path="whatsapp-bot/src/__tests__/engagement/tier-progress-handler.test.ts">
      <test-case>Tier 1 completion queues correct celebration message</test-case>
      <test-case>Tier 2 completion queues correct celebration message</test-case>
      <test-case>Tier 3 completion queues final celebration message</test-case>
      <test-case>Tips disabled skips message queuing</test-case>
      <test-case>Idempotency key format is correct</test-case>
      <test-case>queueMessage called with correct parameters</test-case>
      <test-case>Messages use correct locale</test-case>
    </test-file>
  </tests>

  <implementation-notes>
    <note>Call handleTierCompletion from action hooks when tierCompleted is not null</note>
    <note>Check shouldSendUnlock to determine if celebration needed</note>
    <note>Idempotency key prevents duplicate celebrations on same day</note>
    <note>Fire-and-forget pattern - don't block action response</note>
  </implementation-notes>
</story-context>
